<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Dismissal Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.css" rel="stylesheet">
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen transition-colors duration-300">
    <div id="loginContainer" class="container mx-auto px-4 py-8 max-w-md flex items-center justify-center min-h-screen">
        <!-- Login Panel -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">School Dismissal Manager</h1>
                <p class="text-gray-600 dark:text-gray-300 mt-2">Sign in to access the system</p>
            </div>
            
            <div id="loginError" class="mb-4 p-4 bg-red-50 dark:bg-red-900/30 rounded-lg text-red-800 dark:text-red-200 hidden">
                <i class="fas fa-exclamation-circle mr-1"></i> <span id="loginErrorMessage"></span>
            </div>
            
            <form id="mainLoginForm" class="space-y-4">
                <div>
                    <label for="mainUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                    <input type="text" id="mainUsername" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter your username" required>
                </div>
                
                <div>
                    <label for="mainPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                    <input type="password" id="mainPassword" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter your password" required>
                </div>
                
                <div class="pt-2">
                    <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-md transition-colors">
                        Sign In
                    </button>
                </div>
            </form>
            
            
            </div>
        </div>
    </div>

    <div id="appContainer" class="container mx-auto px-4 py-8 max-w-4xl hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">School Dismissal Manager</h1>
            <p class="text-gray-600 dark:text-gray-300">Streamline student pickup during dismissal time</p>
            
            <!-- View Toggle -->
            <div class="flex justify-center mt-4 flex-wrap">
                <div class="inline-flex rounded-md shadow-sm mb-2" role="group">
                    <button id="adminViewBtn" type="button" class="view-btn px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-l-lg">
                        <i class="fas fa-cog mr-1"></i> Admin
                    </button>
                    <button id="receptionViewBtn" type="button" class="view-btn px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300">
                        <i class="fas fa-clipboard-list mr-1"></i> Reception
                    </button>
                    <button id="securityViewBtn" type="button" class="view-btn px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300">
                        <i class="fas fa-shield-alt mr-1"></i> Security
                    </button>
                    <button id="teacherViewBtn" type="button" class="view-btn px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-r-lg">
                        <i class="fas fa-chalkboard-teacher mr-1"></i> Teacher
                    </button>
                </div>
            </div>

            <div class="flex justify-center mt-3">
                <div class="text-sm text-primary dark:text-primary-400">
                    <i class="fas fa-user mr-1"></i> Logged in as: <span id="currentUserDisplay" class="font-medium"></span>
                </div>
                <button id="logoutBtn" class="text-sm text-red-600 dark:text-red-400 hover:underline ml-4">
                    <i class="fas fa-sign-out-alt mr-1"></i> Logout
                </button>
            </div>
            
            <!-- System Status Bar -->
            <div class="mt-4 p-2 bg-blue-50 dark:bg-blue-900 rounded-lg text-center">
                <span id="systemStatus" class="text-blue-700 dark:text-blue-200">
                    <i class="fas fa-clock mr-1"></i> Loading system status...
                </span>
            </div>
            
            <!-- Data Persistence Controls - Only visible when localStorage is not available -->
            <div id="manualPersistenceControls" class="mt-2 flex justify-center gap-2 hidden">
                <button id="saveDataBtn" class="text-xs px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded-md">
                    <i class="fas fa-save mr-1"></i> Save Data
                </button>
                <button id="loadDataBtn" class="text-xs px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                    <i class="fas fa-upload mr-1"></i> Load Data
                </button>
            </div>
        </header>

        <!-- Admin View -->
        <div id="adminView" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Administration Dashboard</h2>
            
            <!-- Admin Tabs -->
            <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                    <li class="mr-2">
                        <button id="studentsTabBtn" class="studentsTab inline-block p-4 border-b-2 border-primary text-primary rounded-t-lg active">
                            <i class="fas fa-user-graduate mr-1"></i> Students
                        </button>
                    </li>
                    <li class="mr-2">
                        <button id="classesTabBtn" class="classesTab inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg">
                            <i class="fas fa-chalkboard mr-1"></i> Classes
                        </button>
                    </li>
                    <li class="mr-2">
                        <button id="usersTabBtn" class="usersTab inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg">
                            <i class="fas fa-users-cog mr-1"></i> Users
                        </button>
                    </li>
                    <li class="mr-2">
                        <button id="systemTabBtn" class="systemTab inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg">
                            <i class="fas fa-cogs mr-1"></i> System
                        </button>
                    </li>
                </ul>
            </div>
            
            <!-- Students Tab Content -->
            <div id="studentsTabContent" class="tab-content block">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                    <div class="relative w-full md:w-1/2">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="studentSearch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Search for student...">
                    </div>
                    <div class="flex space-x-2">
                        <button id="addStudentBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            <i class="fas fa-plus mr-1"></i> Add Student
                        </button>
                        <button id="bulkAddStudentsBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            <i class="fas fa-file-import mr-1"></i> Bulk Import
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Student Name</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ID</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Class</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Family #</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminStudentsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Students will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex justify-between items-center">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        Showing <span id="studentCount">0</span> students
                    </div>
                    <div class="flex space-x-2">
                        <button class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="px-3 py-1 bg-primary text-white rounded">1</span>
                        <button class="px-3 py-1 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Classes Tab Content -->
            <div id="classesTabContent" class="tab-content hidden">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                    <div class="relative w-full md:w-1/2">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="classSearch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Search for class...">
                    </div>
                    <div>
                        <button id="addClassBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            <i class="fas fa-plus mr-1"></i> Add Class
                        </button>
                    </div>
                </div>
                
                <div id="classList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Class cards will be inserted here -->
                </div>
            </div>

            <!-- Users Tab Content -->
            <div id="usersTabContent" class="tab-content hidden">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">User Management</h3>
                    <div>
                        <button id="addUserBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                            <i class="fas fa-user-plus mr-1"></i> Add User
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Username</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Role</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Full Name</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Users will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 p-4 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg">
                    <div class="text-sm text-yellow-800 dark:text-yellow-200">
                        <i class="fas fa-exclamation-triangle mr-1"></i> <strong>Important:</strong>
                    </div>
                    <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">
                        Changing user credentials will take effect immediately. Make sure to keep track of admin credentials.
                    </p>
                </div>
            </div>
            
            <!-- System Tab Content -->
            <div id="systemTabContent" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- System Settings Section -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">System Settings</h3>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current System Mode</label>
                            <div class="flex space-x-4">
                                <div class="flex items-center">
                                    <input id="mode-morning" name="system-mode" type="radio" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                    <label for="mode-morning" class="ml-2 block text-sm text-gray-900 dark:text-white">Morning (School Day)</label>
                                </div>
                                <div class="flex items-center">
                                    <input id="mode-dismissal" name="system-mode" type="radio" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                    <label for="mode-dismissal" class="ml-2 block text-sm text-gray-900 dark:text-white">Dismissal Time</label>
                                </div>
                            </div>
                            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i> Changing the system mode affects what operations are allowed.
                            </p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">System Reset Options</label>
                            <button id="resetStatusBtn" class="mb-2 w-full px-4 py-2 flex items-center justify-center bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                <i class="fas fa-sync-alt mr-2"></i> Reset All Student Statuses
                            </button>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                This will reset all students to "Waiting in Class" status. Use at the start of a new day.
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Backup & Restore</label>
                            <button id="backupDataBtn" class="mb-2 w-full px-4 py-2 flex items-center justify-center bg-primary text-white rounded-lg hover:bg-primary/90">
                                <i class="fas fa-file-export mr-2"></i> Create Data Backup
                            </button>
                            <button id="restoreDataBtn" class="w-full px-4 py-2 flex items-center justify-center bg-primary text-white rounded-lg hover:bg-primary/90">
                                <i class="fas fa-file-import mr-2"></i> Restore From Backup
                            </button>
                        </div>
                    </div>
                    
                    <!-- System Status Section -->
                    <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-6">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">System Status</h3>
                        
                        <div class="mb-4">
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current Statistics</div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                                    <div class="text-xs text-gray-500 dark:text-gray-400">Total Students</div>
                                    <div class="text-xl font-bold text-gray-900 dark:text-white" id="statTotalStudents">0</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                                    <div class="text-xs text-gray-500 dark:text-gray-400">Total Classes</div>
                                    <div class="text-xl font-bold text-gray-900 dark:text-white" id="statTotalClasses">0</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                                    <div class="text-xs text-gray-500 dark:text-gray-400">Students Waiting</div>
                                    <div class="text-xl font-bold text-gray-900 dark:text-white" id="statStudentsWaiting">0</div>
                                </div>
                                <div class="bg-white dark:bg-gray-800 rounded-lg p-4 shadow-sm">
                                    <div class="text-xs text-gray-500 dark:text-gray-400">Students Absent</div>
                                    <div class="text-xl font-bold text-gray-900 dark:text-white" id="statStudentsAbsent">0</div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">System Version</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">Dismissal Manager v1.0</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 mt-1">Last updated: March 2025</div>
                        </div>
                        
                        <div id="storageStatus" class="mt-4 p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
                            <div class="text-sm text-green-800 dark:text-green-200">
                                <i class="fas fa-check-circle mr-1"></i> Automatic data persistence is active
                            </div>
                            <div class="text-xs text-green-700 dark:text-green-300 mt-1">
                                Your data is automatically saved and will persist between sessions
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Edit Modal -->
        <div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="userModalTitle">Add New User</h3>
                        <button id="closeUserModalBtn" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <form id="userForm" class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Username</label>
                            <input type="text" id="userUsername" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter username" required>
                        </div>
                        
                        <div>
                            <label for="userPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
                            <input type="password" id="userPassword" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter password" required>
                        </div>
                        
                        <div>
                            <label for="userFullName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Full Name</label>
                            <input type="text" id="userFullName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter full name" required>
                        </div>
                        
                        <div>
                            <label for="userRole" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Role</label>
                            <select id="userRole" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                <option value="" disabled selected>Select role</option>
                                <option value="admin">Administrator</option>
                                <option value="reception">Reception</option>
                                <option value="security">Security</option>
                                <option value="teacher">Teacher</option>
                            </select>
                        </div>
                    </form>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-end space-x-3">
                    <button id="cancelUserBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button id="saveUserBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Save User
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Edit Modal -->
        <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="modalTitle">Add New Student</h3>
                        <button id="closeStudentModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <form id="studentForm" class="space-y-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Student Name</label>
                            <input type="text" id="studentName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Enter student's full name" required>
                        </div>
                        
                        <div>
                            <label for="studentId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Student ID</label>
                            <input type="text" id="studentId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Student ID number" required>
                        </div>
                        
                        <div>
                            <label for="studentClass" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Class Assignment</label>
                            <select id="studentClass" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                <option value="" disabled selected>Select class</option>
                                <!-- Class options will be added dynamically -->
                            </select>
                        </div>
                        
                        <div>
                            <label for="familyNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Family Number</label>
                            <input type="text" id="familyNumberInput" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Family identification number" required>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i> Students from the same family should have the same family number.
                            </p>
                        </div>
                        
                        <div>
                            <label for="studentStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                            <select id="studentStatus" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                <option value="waiting">Waiting in Class</option>
                                <option value="ready">Ready for Pickup</option>
                                <option value="picked_up">Picked Up</option>
                                <option value="absent">Absent</option>
                                <option value="dismissed_early">Dismissed Early</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="additionalNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Additional Notes</label>
                            <textarea id="additionalNotes" rows="3" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Any special instructions or notes"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-end space-x-3">
                    <button id="cancelStudentBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button id="saveStudentBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Save Student
                    </button>
                </div>
            </div>
        </div>

        <!-- Class Edit Modal -->
        <div id="classModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="classModalTitle">Add New Class</h3>
                        <button id="closeClassModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <form id="classForm" class="space-y-4">
                        <div>
                            <label for="className" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Class Name</label>
                            <input type="text" id="className" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="e.g. Grade 3-B" required>
                        </div>
                        
                        <div>
                            <label for="classId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Class ID</label>
                            <input type="text" id="classId" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="e.g. grade3b" required>
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i> Use only lowercase letters and numbers. No spaces.
                            </p>
                        </div>
                        
                        <div>
                            <label for="teacherName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Teacher Name</label>
                            <input type="text" id="teacherName" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Teacher's full name" required>
                        </div>
                        
                        <div>
                            <label for="roomNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Room Number</label>
                            <input type="text" id="roomNumber" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="e.g. 101" required>
                        </div>
                    </form>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-end space-x-3">
                    <button id="cancelClassBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button id="saveClassBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Save Class
                    </button>
                </div>
            </div>
        </div>

        <!-- Bulk Import Modal -->
        <div id="bulkImportModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Bulk Import Students</h3>
                        <button id="closeBulkImportModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">
                            Paste student data in CSV format below. Each line should contain: Student Name, ID, Class ID, Family Number, Notes (optional).
                        </p>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                            Example: <code class="bg-gray-100 dark:bg-gray-700 px-1 py-0.5 rounded">John Smith,12345,grade1,101,Allergic to peanuts</code>
                        </p>
                        
                        <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4 mb-2">
                            <div class="text-xs text-gray-500 dark:text-gray-400 mb-2">Available Class IDs:</div>
                            <div id="availableClassIds" class="text-xs text-gray-700 dark:text-gray-300 flex flex-wrap gap-2">
                                <!-- Class IDs will be displayed here -->
                            </div>
                        </div>
                        
                        <textarea id="bulkImportData" rows="8" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm font-mono rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Paste CSV data here..."></textarea>
                    </div>
                    
                    <div id="importPreview" class="hidden">
                        <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Preview:</div>
                        <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg max-h-40 overflow-y-auto">
                            <table class="min-w-full text-xs">
                                <thead>
                                    <tr>
                                        <th class="px-2 py-1 text-left text-gray-500 dark:text-gray-400">Name</th>
                                        <th class="px-2 py-1 text-left text-gray-500 dark:text-gray-400">ID</th>
                                        <th class="px-2 py-1 text-left text-gray-500 dark:text-gray-400">Class</th>
                                        <th class="px-2 py-1 text-left text-gray-500 dark:text-gray-400">Family #</th>
                                    </tr>
                                </thead>
                                <tbody id="previewTable" class="divide-y divide-gray-200 dark:divide-gray-600">
                                    <!-- Preview rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                            <span id="validRowsCount">0</span> valid records found.
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between">
                    <button id="previewImportBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        <i class="fas fa-eye mr-1"></i> Preview Import
                    </button>
                    
                    <div class="flex space-x-3">
                        <button id="cancelImportBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                            Cancel
                        </button>
                        <button id="confirmImportBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-file-import mr-1"></i> Import Students
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Save Modal -->
        <div id="saveDataModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Save Application Data</h3>
                        <button id="closeSaveDataModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                        Copy the data below to save your current school configuration, including all students, classes, and settings. 
                        Save this text to a file on your computer to restore your data later.
                    </p>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 mb-3 rounded border border-gray-300 dark:border-gray-600">
                        <textarea id="savedDataText" rows="10" 
                            class="w-full bg-gray-50 dark:bg-gray-700 border-0 text-gray-900 dark:text-gray-100 text-sm font-mono p-2 focus:ring-0" 
                            readonly></textarea>
                    </div>
                    
                    <div class="flex justify-center">
                        <button id="copyDataBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            <i class="fas fa-copy mr-1"></i> Copy to Clipboard
                        </button>
                    </div>
                    
                    <div id="copySuccess" class="mt-3 text-center text-green-600 dark:text-green-400 hidden">
                        <i class="fas fa-check-circle mr-1"></i> Data copied to clipboard!
                    </div>
                    
                    <div class="mt-4 bg-blue-50 dark:bg-blue-900/30 p-3 rounded-lg text-sm text-blue-800 dark:text-blue-200">
                        <p><i class="fas fa-info-circle mr-1"></i> <strong>Note:</strong></p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li>Your data is automatically saved in the browser. This backup is for transferring to another device or for extra safety.</li>
                            <li>Save this file somewhere safe in case your browser data is cleared.</li>
                        </ul>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-end">
                    <button id="closeSaveModalBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Load Modal -->
        <div id="loadDataModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">Load Application Data</h3>
                        <button id="closeLoadDataModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <p class="text-sm text-gray-700 dark:text-gray-300 mb-3">
                        Paste your previously saved data below to restore your school configuration, including all students, classes, and settings.
                    </p>
                    
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 mb-3 rounded border border-gray-300 dark:border-gray-600">
                        <textarea id="loadDataText" rows="10" 
                            class="w-full bg-gray-50 dark:bg-gray-700 border-0 text-gray-900 dark:text-gray-100 text-sm font-mono p-2 focus:ring-0" 
                            placeholder="Paste your saved data here..."></textarea>
                    </div>
                    
                    <div id="loadError" class="mt-3 text-center text-red-600 dark:text-red-400 hidden">
                        <i class="fas fa-exclamation-circle mr-1"></i> <span id="loadErrorMessage"></span>
                    </div>
                    
                    <div class="mt-4 bg-amber-50 dark:bg-amber-900/30 p-3 rounded-lg text-sm text-amber-800 dark:text-amber-200">
                        <p><i class="fas fa-exclamation-triangle mr-1"></i> <strong>Warning:</strong></p>
                        <ul class="list-disc pl-5 mt-1 space-y-1">
                            <li>Loading new data will replace all current data</li>
                            <li>Make sure to save your current data first if needed</li>
                            <li>This action cannot be undone</li>
                        </ul>
                    </div>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-between">
                    <button id="cancelLoadDataBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button id="confirmLoadDataBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                        <i class="fas fa-upload mr-1"></i> Load Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Student Status Change Modal -->
        <div id="statusChangeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-md mx-4">
                <div class="border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="statusModalTitle">Change Student Status</h3>
                        <button id="closeStatusModal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="px-6 py-4">
                    <div id="statusStudentInfo" class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <p class="text-sm font-medium text-gray-900 dark:text-white" id="statusStudentName"></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400" id="statusStudentClass"></p>
                    </div>
                    
                    <form id="statusForm" class="space-y-4">
                        <div>
                            <label for="newStatus" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">New Status</label>
                            <select id="newStatus" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" required>
                                <option value="waiting">Waiting in Class</option>
                                <option value="ready">Ready for Pickup</option>
                                <option value="picked_up">Picked Up</option>
                                <option value="absent">Absent</option>
                                <option value="dismissed_early">Dismissed Early</option>
                            </select>
                        </div>
                        
                        <div id="exitGateWrapper" class="hidden">
                            <label for="exitGateSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exit Gate</label>
                            <select id="exitGateSelect" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white">
                                <option value="" disabled selected>Select exit gate</option>
                                <option value="gate1">Gate 1 (Main Entrance)</option>
                                <option value="gate2">Gate 2 (East Wing)</option>
                                <option value="gate3">Gate 3 (West Wing)</option>
                                <option value="gate4">Gate 4 (South Entrance)</option>
                            </select>
                        </div>
                        
                        <div id="statusReasonWrapper">
                            <label for="statusReason" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reason</label>
                            <textarea id="statusReason" rows="2" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Reason for status change (optional)"></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="border-t border-gray-200 dark:border-gray-700 px-6 py-4 flex justify-end space-x-3">
                    <button id="cancelStatusBtn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600">
                        Cancel
                    </button>
                    <button id="saveStatusBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                        Update Status
                    </button>
                </div>
            </div>
        </div>

        <!-- Auto-save notification banner -->
        <div id="autoSaveBanner" class="fixed bottom-0 inset-x-0 bg-green-600 text-white text-center p-3 transform transition-transform translate-y-full">
            <div class="container mx-auto flex items-center justify-between">
                <p><i class="fas fa-save mr-2"></i> Your changes have been automatically saved.</p>
                <button id="dismissAutoSaveBanner" class="ml-4 text-white hover:text-green-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Reception View -->
        <div id="receptionView" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Reception: Student Management</h2>
            
            <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                <ul class="flex flex-wrap -mb-px text-sm font-medium text-center">
                    <li class="mr-2">
                        <button id="pickupRequestTabBtn" class="pickupRequestTab inline-block p-4 border-b-2 border-primary text-primary rounded-t-lg active">
                            <i class="fas fa-car mr-1"></i> Pickup Request
                        </button>
                    </li>
                    <li class="mr-2">
                        <button id="studentStatusTabBtn" class="studentStatusTab inline-block p-4 border-b-2 border-transparent hover:text-gray-600 hover:border-gray-300 dark:hover:text-gray-300 rounded-t-lg">
                            <i class="fas fa-clipboard-check mr-1"></i> Student Status
                        </button>
                    </li>
                </ul>
            </div>
            
            <!-- Pickup Request Tab Content -->
            <div id="pickupRequestTabContent" class="tab-content block">
                <form id="pickupForm" class="space-y-4">
                    <div>
                        <label for="familyNumber" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Family Number</label>
                        <input type="text" id="familyNumber" name="familyNumber" 
                               class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" 
                               placeholder="Enter family number" required>
                    </div>
                    
                    <div>
                        <label for="gateSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Exit Gate</label>
                        <select id="gateSelect" name="gateSelect" 
                               class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white" 
                               required>
                            <option value="" disabled selected>Select exit gate</option>
                            <option value="gate1">Gate 1 (Main Entrance)</option>
                            <option value="gate2">Gate 2 (East Wing)</option>
                            <option value="gate3">Gate 3 (West Wing)</option>
                            <option value="gate4">Gate 4 (South Entrance)</option>
                        </select>
                    </div>
                    
                    <div class="pt-2">
                        <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-md transition-colors">
                            Request Pickup
                        </button>
                    </div>
                </form>
                
                <div id="receptionResult" class="mt-6 p-4 rounded-lg border border-gray-200 dark:border-gray-700 hidden">
                    <h3 class="font-medium text-gray-800 dark:text-white mb-2">Pickup Request Status</h3>
                    <div id="receptionResultContent" class="text-gray-600 dark:text-gray-300"></div>
                </div>
            </div>
            
            <!-- Student Status Tab Content -->
            <div id="studentStatusTabContent" class="tab-content hidden">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
                    <div class="relative w-full">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i class="fas fa-search text-gray-400"></i>
                        </div>
                        <input type="text" id="receptionStudentSearch" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary focus:border-primary block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white" placeholder="Search by student name or ID...">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Student Name</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Class</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Family #</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="receptionStudentsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            <!-- Students will be inserted here -->
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-4 flex flex-wrap gap-3">
                    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-gray-200 dark:bg-gray-600"></span>
                        <span>Waiting in Class</span>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                        <span>Ready for Pickup</span>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                        <span>Picked Up</span>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
                        <span>Absent</span>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                        <span class="inline-block w-3 h-3 rounded-full bg-purple-500"></span>
                        <span>Dismissed Early</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Security View -->
        <div id="securityView" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 hidden">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Security: Gate Management</h2>
            
            <div class="mb-6">
                <label for="gateFilterSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Filter by Gate:</label>
                <select id="gateFilterSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                    <option value="all">All Gates</option>
                    <option value="gate1">Gate 1 (Main Entrance)</option>
                    <option value="gate2">Gate 2 (East Wing)</option>
                    <option value="gate3">Gate 3 (West Wing)</option>
                    <option value="gate4">Gate 4 (South Entrance)</option>
                </select>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Student</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Class</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Family #</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="securityStudentsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Students will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                <div class="flex items-center space-x-2 mb-1">
                    <span class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                    <span>Ready for Dismissal</span>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                    <span>Picked Up</span>
                </div>
            </div>
        </div>

        <!-- Teacher View -->
        <div id="teacherView" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 hidden">
            <div class="flex flex-col mb-6">
                <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Class Dismissal Dashboard</h2>
                
                <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg">
                    <label for="classSelect" class="block text-sm font-medium text-blue-700 dark:text-blue-300 mb-2">Select Your Assigned Class:</label>
                    <select id="classSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-primary dark:bg-gray-700 dark:text-white">
                        <option value="all">All Classes (Admin View)</option>
                        <!-- Class options will be added dynamically -->
                    </select>
                    <p class="mt-2 text-xs text-blue-600 dark:text-blue-400">
                        <i class="fas fa-info-circle mr-1"></i> As a teacher, please select your assigned class to view your students' dismissal status.
                    </p>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Student</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Class</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Family #</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Status</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Notes</th>
                        </tr>
                    </thead>
                    <tbody id="teacherStudentsList" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        <!-- Students will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <div class="mt-4 flex flex-wrap gap-3">
                <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                    <span class="inline-block w-3 h-3 rounded-full bg-gray-200 dark:bg-gray-600"></span>
                    <span>Waiting in Class</span>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                    <span class="inline-block w-3 h-3 rounded-full bg-yellow-400"></span>
                    <span>Ready for Pickup</span>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                    <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                    <span>Picked Up</span>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                    <span class="inline-block w-3 h-3 rounded-full bg-red-500"></span>
                    <span>Absent</span>
                </div>
                <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center space-x-2">
                    <span class="inline-block w-3 h-3 rounded-full bg-purple-500"></span>
                    <span>Dismissed Early</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Demo data - Class information
        const defaultClassesData = [
            { id: 'grade1', name: 'Grade 1-A', teacher: 'Ms. Johnson', room: '101' },
            { id: 'grade1b', name: 'Grade 1-B', teacher: 'Mr. Davis', room: '102' },
            { id: 'grade2', name: 'Grade 2-A', teacher: 'Mrs. Wilson', room: '201' },
            { id: 'grade2b', name: 'Grade 2-B', teacher: 'Mr. Thompson', room: '202' },
            { id: 'grade3', name: 'Grade 3-A', teacher: 'Ms. Martinez', room: '301' },
            { id: 'grade3b', name: 'Grade 3-B', teacher: 'Mrs. Clark', room: '302' },
            { id: 'grade4', name: 'Grade 4-A', teacher: 'Mr. Lewis', room: '401' },
            { id: 'grade4b', name: 'Grade 4-B', teacher: 'Ms. Walker', room: '402' }
        ];
        
        // Demo data - Students
        const defaultStudentsData = [
            { id: 1, name: "Emma Smith", grade: "grade1", familyNumber: "101", status: "waiting", exitGate: null, notes: "Allergic to peanuts", statusReason: "" },
            { id: 2, name: "Liam Johnson", grade: "grade1", familyNumber: "102", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 3, name: "Olivia Williams", grade: "grade1", familyNumber: "103", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 4, name: "Noah Brown", grade: "grade1", familyNumber: "104", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 5, name: "Sophia Davis", grade: "grade2", familyNumber: "105", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 6, name: "Jackson Miller", grade: "grade2", familyNumber: "106", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 7, name: "Mia Wilson", grade: "grade2", familyNumber: "107", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 8, name: "Lucas Moore", grade: "grade2", familyNumber: "108", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 9, name: "Isabella Taylor", grade: "grade3", familyNumber: "109", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 10, name: "Aiden Anderson", grade: "grade3", familyNumber: "110", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 11, name: "Harper Thomas", grade: "grade3", familyNumber: "111", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 12, name: "Ethan Jackson", grade: "grade3", familyNumber: "112", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            // Siblings with same family number
            { id: 13, name: "Sophie Martinez", grade: "grade1", familyNumber: "201", status: "waiting", exitGate: null, notes: "Picks up younger brother (Jacob)", statusReason: "" },
            { id: 14, name: "Jacob Martinez", grade: "grade3", familyNumber: "201", status: "waiting", exitGate: null, notes: "Goes with older sister (Sophie)", statusReason: "" },
            { id: 15, name: "Emily Wilson", grade: "grade2", familyNumber: "202", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 16, name: "Michael Wilson", grade: "grade3", familyNumber: "202", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 17, name: "Alex Johnson", grade: "grade1b", familyNumber: "301", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 18, name: "Zoe Williams", grade: "grade1b", familyNumber: "302", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 19, name: "Ryan Baker", grade: "grade2b", familyNumber: "303", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 20, name: "Lily Chen", grade: "grade2b", familyNumber: "304", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 21, name: "Max Turner", grade: "grade3b", familyNumber: "305", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 22, name: "Eva Garcia", grade: "grade3b", familyNumber: "306", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 23, name: "Sam Roberts", grade: "grade4", familyNumber: "307", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 24, name: "Ava Mitchell", grade: "grade4", familyNumber: "308", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 25, name: "Leo Scott", grade: "grade4b", familyNumber: "309", status: "waiting", exitGate: null, notes: "", statusReason: "" },
            { id: 26, name: "Nina Patel", grade: "grade4b", familyNumber: "310", status: "waiting", exitGate: null, notes: "", statusReason: "" }
        ];

        // Default authentication credentials
        const defaultCredentials = {
            admin: { username: 'admin', password: 'admin123', fullName: 'Administrator', role: 'admin' },
            reception: { username: 'reception', password: 'reception123', fullName: 'Reception Staff', role: 'reception' },
            security: { username: 'security', password: 'security123', fullName: 'Security Staff', role: 'security' },
            teacher: { username: 'teacher', password: 'teacher123', fullName: 'Teacher', role: 'teacher' }
        };
        
        // Storage Utilities with Automatic Persistence
        const DataStorage = {
            // Storage systems - localStorage is the main, hash is fallback, manualData is for clipboard import/export
            settings: {
                storagePrefix: 'dismissal_app_',
                usingLocalStorage: false,
                autoSaveDelay: 1000 // Auto-save after 1 second of inactivity
            },
            
            // Auto-save timer
            autoSaveTimer: null,
            
            // Initialize storage
            init: function() {
                // Check if localStorage is available
                try {
                    localStorage.setItem('test', 'test');
                    localStorage.removeItem('test');
                    this.settings.usingLocalStorage = true;
                    
                    // Show appropriate UI controls
                    this.updateStorageUI();
                    
                    console.log("Using localStorage for persistence");
                    return true;
                } catch (e) {
                    this.settings.usingLocalStorage = false;
                    
                    // Show appropriate UI controls
                    this.updateStorageUI();
                    
                    console.log("localStorage not available, using hash-based storage with manual backup");
                    return false;
                }
            },
            
            // Update the storage UI based on available storage
            updateStorageUI: function() {
                const manualControls = document.getElementById('manualPersistenceControls');
                const storageStatus = document.getElementById('storageStatus');
                
                if (this.settings.usingLocalStorage) {
                    // Hide manual controls in the header, update status in system tab
                    if (manualControls) manualControls.classList.add('hidden');
                    if (storageStatus) {
                        storageStatus.className = "mt-4 p-3 bg-green-50 dark:bg-green-900/30 rounded-lg";
                        storageStatus.innerHTML = `
                            <div class="text-sm text-green-800 dark:text-green-200">
                                <i class="fas fa-check-circle mr-1"></i> Automatic data persistence is active
                            </div>
                            <div class="text-xs text-green-700 dark:text-green-300 mt-1">
                                Your data is automatically saved and will persist between sessions
                            </div>
                        `;
                    }
                } else {
                    // Show manual controls in the header, update status in system tab
                    if (manualControls) manualControls.classList.remove('hidden');
                    if (storageStatus) {
                        storageStatus.className = "mt-4 p-3 bg-yellow-50 dark:bg-yellow-900/30 rounded-lg";
                        storageStatus.innerHTML = `
                            <div class="text-sm text-yellow-800 dark:text-yellow-200">
                                <i class="fas fa-exclamation-triangle mr-1"></i> Manual data persistence required
                            </div>
                            <div class="text-xs text-yellow-700 dark:text-yellow-300 mt-1">
                                Use the Save/Load buttons at the top of the page to save your data
                            </div>
                        `;
                    }
                }
            },
            
            // Save data with automatic persistence
            saveData: function(key, value) {
                try {
                    // Always save to memory
                    this.saveToMemory(key, value);
                    
                    // Schedule auto-save
                    this.scheduleAutoSave();
                    
                    return true;
                } catch (e) {
                    console.error("Error saving data:", e);
                    return false;
                }
            },
            
            // Get data with default fallback
            getData: function(key, defaultValue) {
                try {
                    // Try to get from localStorage first if available
                    if (this.settings.usingLocalStorage) {
                        const storedValue = localStorage.getItem(this.settings.storagePrefix + key);
                        if (storedValue !== null) {
                            return JSON.parse(storedValue);
                        }
                    }
                    
                    // Then try hash storage
                    const hashData = this.getAllHashData();
                    if (hashData && hashData[key] !== undefined) {
                        return hashData[key];
                    }
                    
                    // Fall back to default value
                    return defaultValue;
                } catch (e) {
                    console.error("Error retrieving data:", e);
                    return defaultValue;
                }
            },
            
            // Schedule auto-save with debounce
            scheduleAutoSave: function() {
                clearTimeout(this.autoSaveTimer);
                
                this.autoSaveTimer = setTimeout(() => {
                    this.performAutoSave();
                }, this.settings.autoSaveDelay);
            },
            
            // Perform the auto-save operation
            performAutoSave: function() {
                // Collect all data
                const appData = {
                    students,
                    classes,
                    systemMode,
                    users,
                    timestamp: new Date().toISOString(),
                    version: "3.0"
                };
                
                // Save to localStorage if available
                if (this.settings.usingLocalStorage) {
                    try {
                        // Save each piece of data separately for better performance
                        localStorage.setItem(this.settings.storagePrefix + 'students', JSON.stringify(students));
                        localStorage.setItem(this.settings.storagePrefix + 'classes', JSON.stringify(classes));
                        localStorage.setItem(this.settings.storagePrefix + 'systemMode', JSON.stringify(systemMode));
                        localStorage.setItem(this.settings.storagePrefix + 'currentUser', JSON.stringify(currentUser));
                        localStorage.setItem(this.settings.storagePrefix + 'users', JSON.stringify(users));
                        
                        // Show auto-save notification
                        this.showAutoSaveNotification();
                    } catch (e) {
                        console.error("Error auto-saving to localStorage:", e);
                        
                        // Fall back to hash storage
                        this.saveToHashStorage();
                    }
                } else {
                    // If localStorage is not available, save to hash
                    this.saveToHashStorage();
                }
            },
            
            // Save data to memory (always happens)
            saveToMemory: function(key, value) {
                // Function is part of the API but no real implementation needed
                // since we're directly modifying the variables in the outer scope
            },
            
            // Save to hash-based storage
            saveToHashStorage: function() {
                try {
                    const hashData = {
                        students,
                        classes,
                        systemMode,
                        currentUser,
                        users
                    };
                    
                    // Prepare a more compact state for URL storage
                    const compactData = this.getCompactData(hashData);
                    
                    // Compress and encode data for URL storage
                    const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(compactData));
                    
                    // Update URL hash without reloading page
                    window.history.replaceState(null, '', `#${compressedData}`);
                    
                    return true;
                } catch (e) {
                    console.error("Error saving hash data:", e);
                    return false;
                }
            },
            
            // Get all data from hash
            getAllHashData: function() {
                if (!window.location.hash) {
                    return {};
                }
                
                try {
                    const hashContent = window.location.hash.substring(1); // Remove the # character
                    const decompressedContent = LZString.decompressFromEncodedURIComponent(hashContent);
                    return decompressedContent ? JSON.parse(decompressedContent) : {};
                } catch (e) {
                    console.error("Error parsing hash data:", e);
                    return {};
                }
            },
            
            // Create a more compact version of the data for storage
            getCompactData: function(data) {
                const compactData = { ...data };
                
                // If students array exists, make a more compact version
                if (compactData.students) {
                    compactData.students = compactData.students.map(student => {
                        // Only keep necessary fields
                        return {
                            id: student.id,
                            name: student.name,
                            grade: student.grade,
                            familyNumber: student.familyNumber,
                            status: student.status,
                            exitGate: student.exitGate,
                            notes: student.notes || "",
                            statusReason: student.statusReason || ""
                        };
                    });
                }
                
                return compactData;
            },
            
            // Show autosave notification
            showAutoSaveNotification: function() {
                const autoSaveBanner = document.getElementById('autoSaveBanner');
                
                if (autoSaveBanner) {
                    // Show the banner
                    autoSaveBanner.classList.remove('translate-y-full');
                    
                    // Hide after 2 seconds
                    setTimeout(() => {
                        autoSaveBanner.classList.add('translate-y-full');
                    }, 2000);
                }
            },
            
            // Export all application data as a string for manual backup
            exportAllData: function() {
                const data = {
                    students,
                    classes,
                    systemMode,
                    users,
                    timestamp: new Date().toISOString(),
                    version: "3.0"
                };
                
                // Compress the data for smaller output
                return LZString.compressToBase64(JSON.stringify(data));
            },
            
            // Import all application data from a string for manual restore
            importAllData: function(dataStr) {
                try {
                    // Decompress and parse the data
                    const decompressedData = LZString.decompressFromBase64(dataStr);
                    if (!decompressedData) {
                        throw new Error("Invalid data format");
                    }
                    
                    const data = JSON.parse(decompressedData);
                    
                    // Validate data structure
                    if (!data || !data.students || !data.classes || !data.systemMode) {
                        throw new Error("Incomplete data structure");
                    }
                    
                    // Apply the imported data
                    students = data.students;
                    classes = data.classes;
                    systemMode = data.systemMode;
                    
                    // Handle users with backward compatibility
                    if (data.users) {
                        users = data.users;
                    } else {
                        // Use default credentials if no users in imported data
                        users = Object.values(defaultCredentials);
                    }
                    
                    // Save to storage
                    this.saveData('students', students);
                    this.saveData('classes', classes);
                    this.saveData('systemMode', systemMode);
                    this.saveData('users', users);
                    
                    // Force an immediate save to persistent storage
                    this.performAutoSave();
                    
                    return true;
                } catch (e) {
                    console.error("Error importing data:", e);
                    throw e;
                }
            },
            
            // Clear all stored data (for testing or resetting)
            clearAllData: function() {
                if (this.settings.usingLocalStorage) {
                    try {
                        // Clear only our app's data, not all localStorage
                        const keys = Object.keys(localStorage);
                        for (let key of keys) {
                            if (key.startsWith(this.settings.storagePrefix)) {
                                localStorage.removeItem(key);
                            }
                        }
                    } catch (e) {
                        console.error("Error clearing localStorage:", e);
                    }
                }
                
                // Clear hash data
                window.history.replaceState(null, '', window.location.pathname);
            }
        };
        
        // Application state
        let students;
        let classes;
        let systemMode;
        let users;
        let editingStudentId = null; // For tracking which student is being edited
        let editingClassId = null; // For tracking which class is being edited
        let editingUserId = null; // For tracking which user is being edited
        let editingStatusStudentId = null; // For tracking which student status is being edited
        let parsedImportData = null; // For storing parsed CSV import data
        let currentUser = null; // Current authenticated user
        
        // DOM elements - Main containers
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        
        // Views
        const adminView = document.getElementById('adminView');
        const receptionView = document.getElementById('receptionView');
        const securityView = document.getElementById('securityView');
        const teacherView = document.getElementById('teacherView');
        
        // View buttons
        const adminViewBtn = document.getElementById('adminViewBtn');
        const receptionViewBtn = document.getElementById('receptionViewBtn');
        const securityViewBtn = document.getElementById('securityViewBtn');
        const teacherViewBtn = document.getElementById('teacherViewBtn');
        
        // Login elements
        const mainLoginForm = document.getElementById('mainLoginForm');
        const mainUsername = document.getElementById('mainUsername');
        const mainPassword = document.getElementById('mainPassword');
        const loginError = document.getElementById('loginError');
        const loginErrorMessage = document.getElementById('loginErrorMessage');
        
        // Header elements
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserDisplay = document.getElementById('currentUserDisplay');
        const systemStatus = document.getElementById('systemStatus');
        
        // Persistence elements
        const saveDataBtn = document.getElementById('saveDataBtn');
        const loadDataBtn = document.getElementById('loadDataBtn');
        const autoSaveBanner = document.getElementById('autoSaveBanner');
        const dismissAutoSaveBanner = document.getElementById('dismissAutoSaveBanner');
        
        // Save Data Modal elements
        const saveDataModal = document.getElementById('saveDataModal');
        const closeSaveDataModal = document.getElementById('closeSaveDataModal');
        const closeSaveModalBtn = document.getElementById('closeSaveModalBtn');
        const savedDataText = document.getElementById('savedDataText');
        const copyDataBtn = document.getElementById('copyDataBtn');
        const copySuccess = document.getElementById('copySuccess');
        
        // Load Data Modal elements
        const loadDataModal = document.getElementById('loadDataModal');
        const closeLoadDataModal = document.getElementById('closeLoadDataModal');
        const cancelLoadDataBtn = document.getElementById('cancelLoadDataBtn');
        const confirmLoadDataBtn = document.getElementById('confirmLoadDataBtn');
        const loadDataText = document.getElementById('loadDataText');
        const loadError = document.getElementById('loadError');
        const loadErrorMessage = document.getElementById('loadErrorMessage');
        
        // Admin buttons
        const backupDataBtn = document.getElementById('backupDataBtn');
        const restoreDataBtn = document.getElementById('restoreDataBtn');
        
        // Admin tab buttons
        const studentsTabBtn = document.getElementById('studentsTabBtn');
        const classesTabBtn = document.getElementById('classesTabBtn');
        const usersTabBtn = document.getElementById('usersTabBtn');
        const systemTabBtn = document.getElementById('systemTabBtn');
        
        // Admin tab content containers
        const studentsTabContent = document.getElementById('studentsTabContent');
        const classesTabContent = document.getElementById('classesTabContent');
        const usersTabContent = document.getElementById('usersTabContent');
        const systemTabContent = document.getElementById('systemTabContent');
        
        // Reception tab buttons
        const pickupRequestTabBtn = document.getElementById('pickupRequestTabBtn');
        const studentStatusTabBtn = document.getElementById('studentStatusTabBtn');
        
        // Reception tab content containers
        const pickupRequestTabContent = document.getElementById('pickupRequestTabContent');
        const studentStatusTabContent = document.getElementById('studentStatusTabContent');
        
        // User modal elements
        const userModal = document.getElementById('userModal');
        const userModalTitle = document.getElementById('userModalTitle');
        const closeUserModalBtn = document.getElementById('closeUserModalBtn');
        const cancelUserBtn = document.getElementById('cancelUserBtn');
        const saveUserBtn = document.getElementById('saveUserBtn');
        const addUserBtn = document.getElementById('addUserBtn');
        
        // Student modal elements
        const studentModal = document.getElementById('studentModal');
        const modalTitle = document.getElementById('modalTitle');
        const closeStudentModalBtn = document.getElementById('closeStudentModal');
        const cancelStudentBtn = document.getElementById('cancelStudentBtn');
        const saveStudentBtn = document.getElementById('saveStudentBtn');
        const addStudentBtn = document.getElementById('addStudentBtn');
        
        // Class modal elements
        const classModal = document.getElementById('classModal');
        const classModalTitle = document.getElementById('classModalTitle');
        const closeClassModalBtn = document.getElementById('closeClassModal');
        const cancelClassBtn = document.getElementById('cancelClassBtn');
        const saveClassBtn = document.getElementById('saveClassBtn');
        const addClassBtn = document.getElementById('addClassBtn');
        
        // Status change modal elements
        const statusChangeModal = document.getElementById('statusChangeModal');
        const statusModalTitle = document.getElementById('statusModalTitle');
        const closeStatusModalBtn = document.getElementById('closeStatusModal');
        const cancelStatusBtn = document.getElementById('cancelStatusBtn');
        const saveStatusBtn = document.getElementById('saveStatusBtn');
        const statusStudentName = document.getElementById('statusStudentName');
        const statusStudentClass = document.getElementById('statusStudentClass');
        const newStatus = document.getElementById('newStatus');
        const exitGateWrapper = document.getElementById('exitGateWrapper');
        const exitGateSelect = document.getElementById('exitGateSelect');
        const statusReasonWrapper = document.getElementById('statusReasonWrapper');
        const statusReason = document.getElementById('statusReason');
        
        // Bulk import modal elements
        const bulkImportModal = document.getElementById('bulkImportModal');
        const closeBulkImportModalBtn = document.getElementById('closeBulkImportModal');
        const bulkImportData = document.getElementById('bulkImportData');
        const availableClassIds = document.getElementById('availableClassIds');
        const previewImportBtn = document.getElementById('previewImportBtn');
        const cancelImportBtn = document.getElementById('cancelImportBtn');
        const confirmImportBtn = document.getElementById('confirmImportBtn');
        const importPreview = document.getElementById('importPreview');
        const previewTable = document.getElementById('previewTable');
        const validRowsCount = document.getElementById('validRowsCount');
        const bulkAddStudentsBtn = document.getElementById('bulkAddStudentsBtn');
        
        const studentSearch = document.getElementById('studentSearch');
        const adminStudentsList = document.getElementById('adminStudentsList');
        const usersList = document.getElementById('usersList');
        const studentCount = document.getElementById('studentCount');
        
        const pickupForm = document.getElementById('pickupForm');
        const familyNumberInput = document.getElementById('familyNumber');
        const receptionResult = document.getElementById('receptionResult');
        const receptionResultContent = document.getElementById('receptionResultContent');
        
        // Reception students list elements
        const receptionStudentSearch = document.getElementById('receptionStudentSearch');
        const receptionStudentsList = document.getElementById('receptionStudentsList');
        
        const teacherStudentsList = document.getElementById('teacherStudentsList');
        const securityStudentsList = document.getElementById('securityStudentsList');
        
        const classSelect = document.getElementById('classSelect');
        const gateFilterSelect = document.getElementById('gateFilterSelect');
        
        const resetStatusBtn = document.getElementById('resetStatusBtn');
        
        const modeMorningRadio = document.getElementById('mode-morning');
        const modeDismissalRadio = document.getElementById('mode-dismissal');
        
        // Stats elements
        const statTotalStudents = document.getElementById('statTotalStudents');
        const statTotalClasses = document.getElementById('statTotalClasses');
        const statStudentsWaiting = document.getElementById('statStudentsWaiting');
        const statStudentsAbsent = document.getElementById('statStudentsAbsent');
        
        // Initialize UI
        function initializeApp() {
            // Initialize storage system
            DataStorage.init();
            
            // Load saved data or use defaults
            students = DataStorage.getData('students', [...defaultStudentsData]);
            classes = DataStorage.getData('classes', [...defaultClassesData]);
            systemMode = DataStorage.getData('systemMode', "morning");
            users = DataStorage.getData('users', Object.values(defaultCredentials));
            currentUser = DataStorage.getData('currentUser', null);
            
            // Update the current user display if logged in
            updateAuthUI();
            
            // Check if user is logged in
            if (currentUser) {
                // Show app container, hide login container
                appContainer.classList.remove('hidden');
                loginContainer.classList.add('hidden');
                
                // Set initial view based on user role
                if (currentUser.role === 'admin') {
                    showAdminView();
                } else if (currentUser.role === 'reception') {
                    showReceptionView();
                } else if (currentUser.role === 'security') {
                    showSecurityView();
                } else if (currentUser.role === 'teacher') {
                    showTeacherView();
                }
            } else {
                // Show login container, hide app container
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
            }
            
            // Update the system mode display
            updateSystemModeDisplay();
            
            // Update class dropdowns
            updateClassDropdowns();
            
            // Render lists
            renderAdminStudentsList();
            renderClassList();
            renderUsersList();
            renderTeacherStudentsList();
            renderSecurityStudentsList();
            renderReceptionStudentsList();
            updateSystemStats();
            
            // Set up event listeners
            setupEventListeners();
        }
        
        // Event listeners
        function setupEventListeners() {
            // Main login form
            mainLoginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                handleMainLogin();
            });
            
            // Auto-save banner dismiss
            if (dismissAutoSaveBanner) {
                dismissAutoSaveBanner.addEventListener('click', function() {
                    autoSaveBanner.classList.add('translate-y-full');
                });
            }
            
            // Logout button
            logoutBtn.addEventListener('click', logout);
            
            // Data persistence buttons
            if (saveDataBtn) {
                saveDataBtn.addEventListener('click', showSaveDataModal);
            }
            
            if (loadDataBtn) {
                loadDataBtn.addEventListener('click', showLoadDataModal);
            }
            
            // Save Data Modal
            if (closeSaveDataModal) {
                closeSaveDataModal.addEventListener('click', function() {
                    saveDataModal.classList.add('hidden');
                });
            }
            
            if (closeSaveModalBtn) {
                closeSaveModalBtn.addEventListener('click', function() {
                    saveDataModal.classList.add('hidden');
                });
            }
            
            if (copyDataBtn) {
                copyDataBtn.addEventListener('click', copyDataToClipboard);
            }
            
            // Load Data Modal
            if (closeLoadDataModal) {
                closeLoadDataModal.addEventListener('click', function() {
                    loadDataModal.classList.add('hidden');
                    loadError.classList.add('hidden');
                });
            }
            
            if (cancelLoadDataBtn) {
                cancelLoadDataBtn.addEventListener('click', function() {
                    loadDataModal.classList.add('hidden');
                    loadError.classList.add('hidden');
                });
            }
            
            if (confirmLoadDataBtn) {
                confirmLoadDataBtn.addEventListener('click', loadSavedData);
            }
            
            // Admin backup/restore
            if (backupDataBtn) {
                backupDataBtn.addEventListener('click', showSaveDataModal);
            }
            
            if (restoreDataBtn) {
                restoreDataBtn.addEventListener('click', showLoadDataModal);
            }
            
            // View toggle
            adminViewBtn.addEventListener('click', function() {
                if (isAuthorized('admin')) {
                    showAdminView();
                }
            });
            
            receptionViewBtn.addEventListener('click', function() {
                if (isAuthorized('reception') || isAuthorized('admin')) {
                    showReceptionView();
                }
            });
            
            securityViewBtn.addEventListener('click', function() {
                if (isAuthorized('security') || isAuthorized('admin')) {
                    showSecurityView();
                }
            });
            
            teacherViewBtn.addEventListener('click', function() {
                if (isAuthorized('teacher') || isAuthorized('admin')) {
                    showTeacherView();
                }
            });
            
            // Admin tabs
            studentsTabBtn.addEventListener('click', function() {
                showAdminTab('students');
            });
            
            classesTabBtn.addEventListener('click', function() {
                showAdminTab('classes');
            });
            
            usersTabBtn.addEventListener('click', function() {
                showAdminTab('users');
            });
            
            systemTabBtn.addEventListener('click', function() {
                showAdminTab('system');
            });
            
            // Reception tabs
            pickupRequestTabBtn?.addEventListener('click', function() {
                showReceptionTab('pickup');
            });
            
            studentStatusTabBtn?.addEventListener('click', function() {
                showReceptionTab('status');
            });
            
            // System mode radio buttons
            modeMorningRadio?.addEventListener('change', function() {
                if (this.checked) setSystemMode('morning');
            });
            
            modeDismissalRadio?.addEventListener('change', function() {
                if (this.checked) setSystemMode('dismissal');
            });
            
            // Reset status button
            resetStatusBtn?.addEventListener('click', resetDay);
            
            // User modal
            addUserBtn?.addEventListener('click', openAddUserModal);
            closeUserModalBtn?.addEventListener('click', closeUserModal);
            cancelUserBtn?.addEventListener('click', closeUserModal);
            saveUserBtn?.addEventListener('click', saveUser);
            
            // Student modal
            addStudentBtn?.addEventListener('click', openAddStudentModal);
            closeStudentModalBtn?.addEventListener('click', closeStudentModal);
            cancelStudentBtn?.addEventListener('click', closeStudentModal);
            saveStudentBtn?.addEventListener('click', saveStudent);
            
            // Class modal
            addClassBtn?.addEventListener('click', openAddClassModal);
            closeClassModalBtn?.addEventListener('click', closeClassModal);
            cancelClassBtn?.addEventListener('click', closeClassModal);
            saveClassBtn?.addEventListener('click', saveClass);
            
            // Status modal
            closeStatusModalBtn?.addEventListener('click', closeStatusModal);
            cancelStatusBtn?.addEventListener('click', closeStatusModal);
            saveStatusBtn?.addEventListener('click', saveStudentStatus);
            
            // Show/hide exit gate select based on status
            newStatus?.addEventListener('change', function() {
                updateStatusModalFields();
            });
            
            // Bulk import modal
            bulkAddStudentsBtn?.addEventListener('click', openBulkImportModal);
            closeBulkImportModalBtn?.addEventListener('click', closeBulkImportModal);
            cancelImportBtn?.addEventListener('click', closeBulkImportModal);
            previewImportBtn?.addEventListener('click', previewImport);
            confirmImportBtn?.addEventListener('click', importStudents);
            
            // Student search
            studentSearch?.addEventListener('input', renderAdminStudentsList);
            receptionStudentSearch?.addEventListener('input', renderReceptionStudentsList);
            
            // Pickup form
            pickupForm?.addEventListener('submit', handlePickupRequest);
            
            // Filters
            classSelect?.addEventListener('change', renderTeacherStudentsList);
            gateFilterSelect?.addEventListener('change', renderSecurityStudentsList);
            
            // Handle storage event to sync between tabs (if localStorage is used)
            window.addEventListener('storage', function(e) {
                // Only respond to our app's changes
                if (e.key && e.key.startsWith(DataStorage.settings.storagePrefix)) {
                    const keyName = e.key.substring(DataStorage.settings.storagePrefix.length);
                    
                    // Reload the specific data that changed
                    if (keyName === 'students') {
                        students = JSON.parse(e.newValue);
                        renderAdminStudentsList();
                        renderReceptionStudentsList();
                        renderTeacherStudentsList();
                        renderSecurityStudentsList();
                        updateSystemStats();
                    } else if (keyName === 'classes') {
                        classes = JSON.parse(e.newValue);
                        updateClassDropdowns();
                        renderClassList();
                        renderAdminStudentsList();
                        renderReceptionStudentsList();
                        renderTeacherStudentsList();
                    } else if (keyName === 'systemMode') {
                        systemMode = JSON.parse(e.newValue);
                        updateSystemModeDisplay();
                        renderTeacherStudentsList();
                        renderSecurityStudentsList();
                    } else if (keyName === 'currentUser') {
                        const newUser = e.newValue ? JSON.parse(e.newValue) : null;
                        
                        // Only update if the current user changed
                        if (JSON.stringify(currentUser) !== JSON.stringify(newUser)) {
                            currentUser = newUser;
                            updateAuthUI();
                            
                            // Update view if needed
                            if (!currentUser) {
                                // Logged out
                                appContainer.classList.add('hidden');
                                loginContainer.classList.remove('hidden');
                            } else {
                                // Logged in
                                appContainer.classList.remove('hidden');
                                loginContainer.classList.add('hidden');
                                
                                // Set appropriate view
                                if (currentUser.role === 'admin') {
                                    showAdminView();
                                } else if (currentUser.role === 'reception') {
                                    showReceptionView();
                                } else if (currentUser.role === 'security') {
                                    showSecurityView();
                                } else if (currentUser.role === 'teacher') {
                                    showTeacherView();
                                }
                            }
                        }
                    } else if (keyName === 'users') {
                        users = JSON.parse(e.newValue);
                        renderUsersList();
                    }
                }
            });
            
            // Update from URL hash if needed
            window.addEventListener('hashchange', function() {
                if (!DataStorage.settings.usingLocalStorage) {
                    // Only reload from hash if not using localStorage
                    loadFromHash();
                }
            });
        }
        
        // Load data from URL hash (for non-localStorage users)
        function loadFromHash() {
            const hashData = DataStorage.getAllHashData();
            
            if (hashData.students) students = hashData.students;
            if (hashData.classes) classes = hashData.classes;
            if (hashData.systemMode) systemMode = hashData.systemMode;
            if (hashData.currentUser !== undefined) currentUser = hashData.currentUser;
            if (hashData.users) users = hashData.users;
            
            // Update UI
            updateAuthUI();
            updateSystemModeDisplay();
            updateClassDropdowns();
            renderAdminStudentsList();
            renderReceptionStudentsList();
            renderClassList();
            renderUsersList();
            renderTeacherStudentsList();
            renderSecurityStudentsList();
            updateSystemStats();
        }
        
        // Handle the main login form submission
        function handleMainLogin() {
            const username = mainUsername.value.trim();
            const password = mainPassword.value.trim();
            
            if (!username || !password) {
                showLoginError("Please enter both username and password.");
                return;
            }
            
            // Find the user with matching credentials
            const user = users.find(u => 
                u.username.toLowerCase() === username.toLowerCase() && 
                u.password === password
            );
            
            if (user) {
                // User found, set current user
                currentUser = {
                    username: user.username,
                    role: user.role,
                    fullName: user.fullName
                };
                
                // Save to storage
                DataStorage.saveData('currentUser', currentUser);
                
                // Hide login container, show app container
                loginContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');
                
                // Clear login form
                mainUsername.value = '';
                mainPassword.value = '';
                hideLoginError();
                
                // Update user display
                updateAuthUI();
                
                // Show appropriate view based on role
                if (user.role === 'admin') {
                    showAdminView();
                } else if (user.role === 'reception') {
                    showReceptionView();
                } else if (user.role === 'security') {
                    showSecurityView();
                } else if (user.role === 'teacher') {
                    showTeacherView();
                }
            } else {
                // Invalid credentials
                showLoginError("Invalid username or password.");
            }
        }
        
        // Show login error message
        function showLoginError(message) {
            loginError.classList.remove('hidden');
            loginErrorMessage.textContent = message;
        }
        
        // Hide login error message
        function hideLoginError() {
            loginError.classList.add('hidden');
        }
        
        // Show Save Data Modal
        function showSaveDataModal() {
            // Generate the data string for export
            const exportData = DataStorage.exportAllData();
            savedDataText.value = exportData;
            
            // Hide any previous success message
            copySuccess.classList.add('hidden');
            
            // Show the modal
            saveDataModal.classList.remove('hidden');
        }
        
        // Copy data to clipboard
        function copyDataToClipboard() {
            try {
                // Select the text
                savedDataText.select();
                savedDataText.setSelectionRange(0, 99999); // For mobile devices
                
                // Copy to clipboard
                document.execCommand('copy');
                
                // Deselect the text
                window.getSelection().removeAllRanges();
                
                // Show success message
                copySuccess.classList.remove('hidden');
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    copySuccess.classList.add('hidden');
                }, 3000);
            } catch (e) {
                console.error("Error copying data: ", e);
                alert("Error copying data to clipboard. Please try again or manually select and copy the text.");
            }
        }
        
        // Show Load Data Modal
        function showLoadDataModal() {
            // Clear any previous data and errors
            loadDataText.value = '';
            loadError.classList.add('hidden');
            
            // Show the modal
            loadDataModal.classList.remove('hidden');
        }
        
        // Load saved data
        function loadSavedData() {
            // Get the data string from the text area
            const dataStr = loadDataText.value.trim();
            
            if (!dataStr) {
                loadError.classList.remove('hidden');
                loadErrorMessage.textContent = "Please paste your saved data into the text field.";
                return;
            }
            
            try {
                // Import the data
                DataStorage.importAllData(dataStr);
                
                // Close the modal
                loadDataModal.classList.add('hidden');
                
                // Update the UI
                updateAuthUI();
                updateSystemModeDisplay();
                updateClassDropdowns();
                renderAdminStudentsList();
                renderReceptionStudentsList();
                renderClassList();
                renderUsersList();
                renderTeacherStudentsList();
                renderSecurityStudentsList();
                updateSystemStats();
                
                // Show confirmation
                alert("Data loaded successfully!");
            } catch (e) {
                // Show error
                loadError.classList.remove('hidden');
                loadErrorMessage.textContent = "Invalid data format. Please check that you've pasted the correct data.";
                console.error("Error loading data: ", e);
            }
        }
        
        // Authentication functions
        function isAuthorized(requiredRole) {
            // Check if user is logged in and has the required role
            return currentUser && (currentUser.role === requiredRole || currentUser.role === 'admin');
        }
        
        function logout() {
            currentUser = null;
            DataStorage.saveData('currentUser', null);
            
            // Hide app container, show login container
            appContainer.classList.add('hidden');
            loginContainer.classList.remove('hidden');
            
            // Clear login form
            mainUsername.value = '';
            mainPassword.value = '';
            hideLoginError();
        }
        
        function updateAuthUI() {
            if (currentUser) {
                // Display current user info
                currentUserDisplay.textContent = `${currentUser.fullName} (${currentUser.role})`;
                
                // Enable buttons based on role
                adminViewBtn.classList.add('opacity-50', 'cursor-not-allowed');
                receptionViewBtn.classList.add('opacity-50', 'cursor-not-allowed');
                securityViewBtn.classList.add('opacity-50', 'cursor-not-allowed');
                teacherViewBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                if (currentUser.role === 'admin') {
                    adminViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    receptionViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    securityViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    teacherViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else if (currentUser.role === 'reception') {
                    receptionViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else if (currentUser.role === 'security') {
                    securityViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else if (currentUser.role === 'teacher') {
                    teacherViewBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        }
        
        // Show a specific admin tab
        function showAdminTab(tabName) {
            // Hide all tab content
            studentsTabContent.classList.add('hidden');
            classesTabContent.classList.add('hidden');
            usersTabContent.classList.add('hidden');
            systemTabContent.classList.add('hidden');
            
            // Reset all tab buttons
            studentsTabBtn.classList.remove('border-primary', 'text-primary');
            studentsTabBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            classesTabBtn.classList.remove('border-primary', 'text-primary');
            classesTabBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            usersTabBtn.classList.remove('border-primary', 'text-primary');
            usersTabBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            systemTabBtn.classList.remove('border-primary', 'text-primary');
            systemTabBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            // Show the selected tab
            if (tabName === 'students') {
                studentsTabContent.classList.remove('hidden');
                studentsTabBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                studentsTabBtn.classList.add('border-primary', 'text-primary');
                renderAdminStudentsList();
            } else if (tabName === 'classes') {
                classesTabContent.classList.remove('hidden');
                classesTabBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                classesTabBtn.classList.add('border-primary', 'text-primary');
                renderClassList();
            } else if (tabName === 'users') {
                usersTabContent.classList.remove('hidden');
                usersTabBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                usersTabBtn.classList.add('border-primary', 'text-primary');
                renderUsersList();
            } else if (tabName === 'system') {
                systemTabContent.classList.remove('hidden');
                systemTabBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                systemTabBtn.classList.add('border-primary', 'text-primary');
                updateSystemStats();
            }
        }
        
        // Show a specific reception tab
        function showReceptionTab(tabName) {
            // Hide all tab content
            pickupRequestTabContent.classList.add('hidden');
            studentStatusTabContent.classList.add('hidden');
            
            // Reset all tab buttons
            pickupRequestTabBtn.classList.remove('border-primary', 'text-primary');
            pickupRequestTabBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            studentStatusTabBtn.classList.remove('border-primary', 'text-primary');
            studentStatusTabBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
            
            // Show the selected tab
            if (tabName === 'pickup') {
                pickupRequestTabContent.classList.remove('hidden');
                pickupRequestTabBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                pickupRequestTabBtn.classList.add('border-primary', 'text-primary');
            } else if (tabName === 'status') {
                studentStatusTabContent.classList.remove('hidden');
                studentStatusTabBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                studentStatusTabBtn.classList.add('border-primary', 'text-primary');
                renderReceptionStudentsList();
            }
        }
        
        // Show admin view
        function showAdminView() {
            if (!isAuthorized('admin')) {
                return;
            }
            
            adminView.classList.remove('hidden');
            receptionView.classList.add('hidden');
            securityView.classList.add('hidden');
            teacherView.classList.add('hidden');
            
            adminViewBtn.classList.add('bg-primary', 'text-white');
            adminViewBtn.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            receptionViewBtn.classList.remove('bg-primary', 'text-white');
            receptionViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            securityViewBtn.classList.remove('bg-primary', 'text-white');
            securityViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            teacherViewBtn.classList.remove('bg-primary', 'text-white');
            teacherViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            // Default to students tab
            showAdminTab('students');
        }
        
        // Show reception view
        function showReceptionView() {
            if (!isAuthorized('reception') && !isAuthorized('admin')) {
                return;
            }
            
            adminView.classList.add('hidden');
            receptionView.classList.remove('hidden');
            securityView.classList.add('hidden');
            teacherView.classList.add('hidden');
            
            receptionViewBtn.classList.add('bg-primary', 'text-white');
            receptionViewBtn.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            adminViewBtn.classList.remove('bg-primary', 'text-white');
            adminViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            securityViewBtn.classList.remove('bg-primary', 'text-white');
            securityViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            teacherViewBtn.classList.remove('bg-primary', 'text-white');
            teacherViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            // Default to pickup tab
            showReceptionTab('pickup');
        }
        
        // Show security view
        function showSecurityView() {
            if (!isAuthorized('security') && !isAuthorized('admin')) {
                return;
            }
            
            adminView.classList.add('hidden');
            receptionView.classList.add('hidden');
            securityView.classList.remove('hidden');
            teacherView.classList.add('hidden');
            
            securityViewBtn.classList.add('bg-primary', 'text-white');
            securityViewBtn.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            adminViewBtn.classList.remove('bg-primary', 'text-white');
            adminViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            receptionViewBtn.classList.remove('bg-primary', 'text-white');
            receptionViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            teacherViewBtn.classList.remove('bg-primary', 'text-white');
            teacherViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            // Refresh security student list
            renderSecurityStudentsList();
        }
        
        // Show teacher view
        function showTeacherView() {
            if (!isAuthorized('teacher') && !isAuthorized('admin')) {
                return;
            }
            
            adminView.classList.add('hidden');
            receptionView.classList.add('hidden');
            securityView.classList.add('hidden');
            teacherView.classList.remove('hidden');
            
            teacherViewBtn.classList.add('bg-primary', 'text-white');
            teacherViewBtn.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            adminViewBtn.classList.remove('bg-primary', 'text-white');
            adminViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            receptionViewBtn.classList.remove('bg-primary', 'text-white');
            receptionViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            securityViewBtn.classList.remove('bg-primary', 'text-white');
            securityViewBtn.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-300');
            
            // Refresh teacher student list
            renderTeacherStudentsList();
        }
        
        // Update class dropdowns
        function updateClassDropdowns() {
            // Update the class select dropdown in student modal
            const studentClassSelect = document.getElementById('studentClass');
            if (studentClassSelect) {
                // Clear existing options except the first one
                while (studentClassSelect.options.length > 1) {
                    studentClassSelect.remove(1);
                }
                
                // Add class options
                classes.forEach(classInfo => {
                    const option = document.createElement('option');
                    option.value = classInfo.id;
                    option.textContent = classInfo.name;
                    studentClassSelect.appendChild(option);
                });
            }
            
            // Update the class select dropdown in teacher view
            if (classSelect) {
                // Save current selection
                const currentSelection = classSelect.value;
                
                // Clear existing options except the first one
                while (classSelect.options.length > 1) {
                    classSelect.remove(1);
                }
                
                // Add class options
                classes.forEach(classInfo => {
                    const option = document.createElement('option');
                    option.value = classInfo.id;
                    option.textContent = classInfo.name;
                    classSelect.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (currentSelection) {
                    for (let i = 0; i < classSelect.options.length; i++) {
                        if (classSelect.options[i].value === currentSelection) {
                            classSelect.selectedIndex = i;
                            break;
                        }
                    }
                }
            }
        }
        
        // Update system mode display
        function updateSystemModeDisplay() {
            if (systemMode === "morning") {
                systemStatus.innerHTML = '<i class="fas fa-sun mr-1"></i> School Day in Progress';
                
                // Update radio buttons in admin panel
                if (modeMorningRadio) modeMorningRadio.checked = true;
                if (modeDismissalRadio) modeDismissalRadio.checked = false;
            } else {
                systemStatus.innerHTML = '<i class="fas fa-bell mr-1"></i> Dismissal Time in Progress';
                
                // Update radio buttons in admin panel
                if (modeMorningRadio) modeMorningRadio.checked = false;
                if (modeDismissalRadio) modeDismissalRadio.checked = true;
            }
        }
        
        // Update system statistics
        function updateSystemStats() {
            const waitingCount = students.filter(s => s.status === 'waiting').length;
            const readyCount = students.filter(s => s.status === 'ready').length;
            const pickedUpCount = students.filter(s => s.status === 'picked_up').length;
            const absentCount = students.filter(s => s.status === 'absent').length + students.filter(s => s.status === 'dismissed_early').length;
            
            if (statTotalStudents) statTotalStudents.textContent = students.length;
            if (statTotalClasses) statTotalClasses.textContent = classes.length;
            if (statStudentsWaiting) statStudentsWaiting.textContent = waitingCount + readyCount;
            if (statStudentsAbsent) statStudentsAbsent.textContent = absentCount;
        }
        
        // Open add user modal
        function openAddUserModal() {
            userModalTitle.textContent = 'Add New User';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userRole').selectedIndex = 0;
            editingUserId = null;
            userModal.classList.remove('hidden');
        }
        
        // Open edit user modal
        function openEditUserModal(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            userModalTitle.textContent = 'Edit User';
            document.getElementById('userUsername').value = user.username;
            document.getElementById('userPassword').value = user.password;
            document.getElementById('userFullName').value = user.fullName || '';
            
            // Set the role dropdown
            const roleSelect = document.getElementById('userRole');
            for (let i = 0; i < roleSelect.options.length; i++) {
                if (roleSelect.options[i].value === user.role) {
                    roleSelect.selectedIndex = i;
                    break;
                }
            }
            
            editingUserId = username;
            userModal.classList.remove('hidden');
        }
        
        // Close user modal
        function closeUserModal() {
            userModal.classList.add('hidden');
        }
        
        // Save user
        function saveUser() {
            const username = document.getElementById('userUsername').value.trim();
            const password = document.getElementById('userPassword').value;
            const fullName = document.getElementById('userFullName').value.trim();
            const role = document.getElementById('userRole').value;
            
            if (!username || !password || !fullName || !role) {
                alert('Please fill out all fields.');
                return;
            }
            
            if (editingUserId) {
                // Updating existing user
                const index = users.findIndex(u => u.username === editingUserId);
                if (index !== -1) {
                    // Check if username is being changed and already exists
                    if (username !== editingUserId && users.some(u => u.username === username)) {
                        alert('A user with this username already exists.');
                        return;
                    }
                    
                    users[index] = {
                        username,
                        password,
                        fullName,
                        role
                    };
                    
                    // If the current user is being edited, update the current user
                    if (currentUser && currentUser.username === editingUserId) {
                        currentUser.username = username;
                        currentUser.fullName = fullName;
                        currentUser.role = role;
                        
                        // Update current user display
                        DataStorage.saveData('currentUser', currentUser);
                        updateAuthUI();
                    }
                }
            } else {
                // Adding new user
                if (users.some(u => u.username === username)) {
                    alert('A user with this username already exists.');
                    return;
                }
                
                users.push({
                    username,
                    password,
                    fullName,
                    role
                });
            }
            
            // Save to storage
            DataStorage.saveData('users', users);
            
            closeUserModal();
            renderUsersList();
        }
        
        // Delete user
        function deleteUser(username) {
            // Don't allow deleting the current user
            if (currentUser && currentUser.username === username) {
                alert('You cannot delete your own account.');
                return;
            }
            
            // Don't allow deleting the last admin
            const adminUsers = users.filter(u => u.role === 'admin');
            if (adminUsers.length === 1 && adminUsers[0].username === username) {
                alert('You cannot delete the last administrator account.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.username !== username);
                
                // Save to storage
                DataStorage.saveData('users', users);
                
                renderUsersList();
            }
        }
        
        // Open add student modal
        function openAddStudentModal() {
            modalTitle.textContent = 'Add New Student';
            document.getElementById('studentName').value = '';
            document.getElementById('studentId').value = '';
            document.getElementById('studentClass').selectedIndex = 0;
            document.getElementById('familyNumberInput').value = '';
            document.getElementById('studentStatus').value = 'waiting';
            document.getElementById('additionalNotes').value = '';
            editingStudentId = null;
            studentModal.classList.remove('hidden');
        }
        
        // Open edit student modal
        function openEditStudentModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            modalTitle.textContent = 'Edit Student';
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentId').value = studentId;
            
            // Find the option for the student's grade
            const classSelect = document.getElementById('studentClass');
            for (let i = 0; i < classSelect.options.length; i++) {
                if (classSelect.options[i].value === student.grade) {
                    classSelect.selectedIndex = i;
                    break;
                }
            }
            
            document.getElementById('familyNumberInput').value = student.familyNumber;
            document.getElementById('studentStatus').value = student.status;
            document.getElementById('additionalNotes').value = student.notes || '';
            editingStudentId = studentId;
            studentModal.classList.remove('hidden');
        }
        
        // Close student modal
        function closeStudentModal() {
            studentModal.classList.add('hidden');
        }
        
        // Open status change modal
        function openStatusChangeModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            statusModalTitle.textContent = 'Change Student Status';
            statusStudentName.textContent = student.name;
            
            // Get class name for display
            const classInfo = classes.find(c => c.id === student.grade);
            statusStudentClass.textContent = classInfo ? classInfo.name : student.grade;
            
            // Set current status
            newStatus.value = student.status;
            
            // Set exit gate if applicable
            if (student.exitGate) {
                exitGateSelect.value = student.exitGate;
            } else {
                exitGateSelect.selectedIndex = 0;
            }
            
            // Set status reason if applicable
            statusReason.value = student.statusReason || '';
            
            // Update fields visibility
            updateStatusModalFields();
            
            editingStatusStudentId = studentId;
            statusChangeModal.classList.remove('hidden');
        }
        
        // Close status modal
        function closeStatusModal() {
            statusChangeModal.classList.add('hidden');
        }
        
        // Update status modal fields based on selected status
        function updateStatusModalFields() {
            if (newStatus.value === 'ready') {
                exitGateWrapper.classList.remove('hidden');
                statusReasonWrapper.classList.remove('hidden');
            } else if (newStatus.value === 'absent' || newStatus.value === 'dismissed_early') {
                exitGateWrapper.classList.add('hidden');
                statusReasonWrapper.classList.remove('hidden');
            } else {
                exitGateWrapper.classList.add('hidden');
                statusReasonWrapper.classList.add('hidden');
            }
        }
        
        // Save student status change
        function saveStudentStatus() {
            const status = newStatus.value;
            const exitGate = status === 'ready' ? exitGateSelect.value : null;
            const reason = statusReason.value.trim();
            
            if (status === 'ready' && !exitGate) {
                alert('Please select an exit gate for a student ready for pickup.');
                return;
            }
            
            if ((status === 'absent' || status === 'dismissed_early') && !reason) {
                alert('Please provide a reason for absence or early dismissal.');
                return;
            }
            
            const index = students.findIndex(s => s.id === editingStatusStudentId);
            if (index !== -1) {
                students[index].status = status;
                students[index].exitGate = exitGate;
                students[index].statusReason = reason;
                
                // Save to storage
                DataStorage.saveData('students', students);
                
                // Update views
                renderAdminStudentsList();
                renderReceptionStudentsList();
                renderTeacherStudentsList();
                renderSecurityStudentsList();
                updateSystemStats();
                
                closeStatusModal();
            }
        }
        
        // Open add class modal
        function openAddClassModal() {
            classModalTitle.textContent = 'Add New Class';
            document.getElementById('className').value = '';
            document.getElementById('classId').value = '';
            document.getElementById('teacherName').value = '';
            document.getElementById('roomNumber').value = '';
            editingClassId = null;
            classModal.classList.remove('hidden');
        }
        
        // Open edit class modal
        function openEditClassModal(classId) {
            const classInfo = classes.find(c => c.id === classId);
            if (!classInfo) return;
            
            classModalTitle.textContent = 'Edit Class';
            document.getElementById('className').value = classInfo.name;
            document.getElementById('classId').value = classInfo.id;
            document.getElementById('teacherName').value = classInfo.teacher;
            document.getElementById('roomNumber').value = classInfo.room;
            editingClassId = classId;
            classModal.classList.remove('hidden');
        }
        
        // Close class modal
        function closeClassModal() {
            classModal.classList.add('hidden');
        }
        
        // Open bulk import modal
        function openBulkImportModal() {
            // Reset the modal
            bulkImportData.value = '';
            importPreview.classList.add('hidden');
            confirmImportBtn.disabled = true;
            parsedImportData = null;
            
            // Display available class IDs
            availableClassIds.innerHTML = '';
            classes.forEach(classInfo => {
                const classIdPill = document.createElement('span');
                classIdPill.className = 'px-1.5 py-0.5 bg-gray-200 dark:bg-gray-600 rounded';
                classIdPill.textContent = classInfo.id;
                availableClassIds.appendChild(classIdPill);
            });
            
            bulkImportModal.classList.remove('hidden');
        }
        
        // Close bulk import modal
        function closeBulkImportModal() {
            bulkImportModal.classList.add('hidden');
        }
        
        // Preview import data
        function previewImport() {
            const csvData = bulkImportData.value.trim();
            
            if (!csvData) {
                alert('Please enter student data in CSV format.');
                return;
            }
            
            // Parse CSV data
            const lines = csvData.split(/\r?\n/);
            const validData = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                if (!line.trim()) return; // Skip empty lines
                
                const parts = line.split(',').map(part => part.trim());
                
                if (parts.length < 4) {
                    errors.push(`Line ${index + 1}: Not enough fields. Expected at least 4 (Name, ID, Class, Family#)`);
                    return;
                }
                
                const [name, id, grade, familyNumber, ...notes] = parts;
                
                // Validate class exists
                if (!classes.some(c => c.id === grade)) {
                    errors.push(`Line ${index + 1}: Class "${grade}" does not exist`);
                    return;
                }
                
                // Add valid student data
                validData.push({
                    name,
                    id: parseInt(id) || id,
                    grade,
                    familyNumber,
                    notes: notes.join(', '),
                    status: 'waiting',
                    exitGate: null,
                    statusReason: ''
                });
            });
            
            if (errors.length > 0) {
                alert(`Found ${errors.length} errors in the import data:\n\n${errors.join('\n')}`);
            }
            
            if (validData.length > 0) {
                // Show preview
                previewTable.innerHTML = '';
                validData.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-2 py-1 text-gray-700 dark:text-gray-300">${student.name}</td>
                        <td class="px-2 py-1 text-gray-700 dark:text-gray-300">${student.id}</td>
                        <td class="px-2 py-1 text-gray-700 dark:text-gray-300">${student.grade}</td>
                        <td class="px-2 py-1 text-gray-700 dark:text-gray-300">${student.familyNumber}</td>
                    `;
                    previewTable.appendChild(row);
                });
                
                validRowsCount.textContent = validData.length;
                importPreview.classList.remove('hidden');
                confirmImportBtn.disabled = false;
                
                // Store parsed data for import
                parsedImportData = validData;
            } else {
                importPreview.classList.add('hidden');
                confirmImportBtn.disabled = true;
                parsedImportData = null;
                
                if (errors.length === 0) {
                    alert('No valid data found to import.');
                }
            }
        }
        
        // Import students from parsed data
        function importStudents() {
            if (!parsedImportData || parsedImportData.length === 0) {
                alert('No valid data to import');
                return;
            }
            
            // Get the next available ID
            let nextId = 1;
            if (students.length > 0) {
                nextId = Math.max(...students.map(s => typeof s.id === 'number' ? s.id : 0)) + 1;
            }
            
            // Add the students
            const newStudents = parsedImportData.map(student => {
                // Use provided ID if numeric, otherwise assign a new one
                const id = typeof student.id === 'number' ? student.id : nextId++;
                return { 
                    ...student, 
                    id,
                    status: 'waiting',
                    exitGate: null,
                    statusReason: ''
                };
            });
            
            // Append to students array
            students = [...students, ...newStudents];
            
            // Save to persistent storage
            DataStorage.saveData('students', students);
            
            // Update UI
            renderAdminStudentsList();
            renderReceptionStudentsList();
            renderTeacherStudentsList();
            updateSystemStats();
            
            // Close modal
            closeBulkImportModal();
            
            // Show feedback
            alert(`Successfully imported ${newStudents.length} students.`);
        }
        
        // Save student
        function saveStudent() {
            const name = document.getElementById('studentName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            const grade = document.getElementById('studentClass').value;
            const familyNumber = document.getElementById('familyNumberInput').value.trim();
            const status = document.getElementById('studentStatus').value;
            const notes = document.getElementById('additionalNotes').value.trim();
            
            if (!name || !studentId || !grade || !familyNumber) {
                alert('Please fill out all required fields.');
                return;
            }
            
            if (editingStudentId) {
                // Editing existing student
                const index = students.findIndex(s => s.id === editingStudentId);
                if (index !== -1) {
                    students[index] = {
                        ...students[index],
                        name,
                        grade,
                        familyNumber,
                        status,
                        notes,
                        exitGate: status === 'ready' ? students[index].exitGate : null
                    };
                }
            } else {
                // Adding new student
                const newId = students.length > 0 ? Math.max(...students.map(s => typeof s.id === 'number' ? s.id : 0)) + 1 : 1;
                students.push({
                    id: newId,
                    name,
                    grade,
                    familyNumber,
                    status,
                    exitGate: null,
                    notes,
                    statusReason: ''
                });
            }
            
            // Save to persistent storage
            DataStorage.saveData('students', students);
            
            closeStudentModal();
            renderAdminStudentsList();
            renderReceptionStudentsList();
            renderTeacherStudentsList();
            updateSystemStats();
        }
        
        // Save class
        function saveClass() {
            const name = document.getElementById('className').value.trim();
            const id = document.getElementById('classId').value.trim();
            const teacher = document.getElementById('teacherName').value.trim();
            const room = document.getElementById('roomNumber').value.trim();
            
            if (!name || !id || !teacher || !room) {
                alert('Please fill out all required fields.');
                return;
            }
            
            // Validate ID format (lowercase letters, numbers, no spaces)
            if (!/^[a-z0-9]+$/.test(id)) {
                alert('Class ID must contain only lowercase letters and numbers with no spaces.');
                return;
            }
            
            // Check if ID already exists (for new classes)
            if (!editingClassId && classes.some(c => c.id === id)) {
                alert('A class with this ID already exists. Please use a different ID.');
                return;
            }
            
            if (editingClassId) {
                // Editing existing class
                const index = classes.findIndex(c => c.id === editingClassId);
                if (index !== -1) {
                    const oldId = classes[index].id;
                    classes[index] = { id, name, teacher, room };
                    
                    // Update student records if class ID changed
                    if (oldId !== id) {
                        students = students.map(student => {
                            if (student.grade === oldId) {
                                return { ...student, grade: id };
                            }
                            return student;
                        });
                    }
                }
            } else {
                // Adding new class
                classes.push({ id, name, teacher, room });
            }
            
            // Save to persistent storage
            DataStorage.saveData('classes', classes);
            DataStorage.saveData('students', students);
            
            // Update class dropdowns
            updateClassDropdowns();
            
            closeClassModal();
            renderClassList();
            renderAdminStudentsList();
            renderReceptionStudentsList();
            renderTeacherStudentsList();
            updateSystemStats();
        }
        
        // Delete student
        function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student?')) {
                students = students.filter(s => s.id !== studentId);
                
                // Save to persistent storage
                DataStorage.saveData('students', students);
                
                renderAdminStudentsList();
                renderReceptionStudentsList();
                renderTeacherStudentsList();
                updateSystemStats();
            }
        }
        
        // Delete class
        function deleteClass(classId) {
            // Check if there are students in this class
            const studentsInClass = students.filter(s => s.grade === classId);
            
            if (studentsInClass.length > 0) {
                alert(`Cannot delete this class. There are ${studentsInClass.length} students assigned to it. Please reassign or delete these students first.`);
                return;
            }
            
            if (confirm('Are you sure you want to delete this class?')) {
                classes = classes.filter(c => c.id !== classId);
                
                // Save to persistent storage
                DataStorage.saveData('classes', classes);
                
                // Update class dropdowns
                updateClassDropdowns();
                
                renderClassList();
                updateSystemStats();
            }
        }
        
        // Set system mode (morning or dismissal)
        function setSystemMode(mode) {
            systemMode = mode;
            
            // Update UI to reflect mode change
            updateSystemModeDisplay();
            
            // Save the system mode to persistent storage
            DataStorage.saveData('systemMode', systemMode);
            
            // Update all views
            renderTeacherStudentsList();
            renderSecurityStudentsList();
        }
        
        // Handle pickup request
        function handlePickupRequest(e) {
            e.preventDefault();
            
            const familyNumber = familyNumberInput.value.trim();
            const exitGate = document.getElementById('gateSelect').value;
            
            if (!familyNumber) {
                showReceptionResult('error', 'Please enter a valid family number.');
                return;
            }
            
            if (!exitGate) {
                showReceptionResult('error', 'Please select an exit gate.');
                return;
            }
            
            if (systemMode !== "dismissal") {
                showReceptionResult('warning', 'It is not dismissal time yet. Please wait until dismissal time to request pickup.');
                return;
            }
            
            // Find students with matching family number
            const matchingStudents = students.filter(student => student.familyNumber === familyNumber);
            
            if (matchingStudents.length === 0) {
                showReceptionResult('error', 'No students found with this family number. Please check and try again.');
                return;
            }
            
            // Check for absent students
            const absentStudents = matchingStudents.filter(student => student.status === 'absent' || student.status === 'dismissed_early');
            
            // Get gate name for display
            const gateNames = {
                'gate1': 'Gate 1 (Main Entrance)',
                'gate2': 'Gate 2 (East Wing)',
                'gate3': 'Gate 3 (West Wing)',
                'gate4': 'Gate 4 (South Entrance)'
            };
            const gateName = gateNames[exitGate];
            
            // Update status for all matching students who are not absent
            const availableStudents = matchingStudents.filter(student => student.status !== 'absent' && student.status !== 'dismissed_early');
            
            availableStudents.forEach(student => {
                const index = students.findIndex(s => s.id === student.id);
                if (index !== -1) {
                    // If waiting, set to ready. If already ready or picked up, leave as is.
                    if (students[index].status === "waiting") {
                        students[index].status = "ready";
                        students[index].exitGate = exitGate;
                    }
                }
            });
            
            // Save to persistent storage
            DataStorage.saveData('students', students);
            
            // Show success message with gate information
            let message = '';
            
            if (availableStudents.length > 0) {
                const studentNames = availableStudents.map(student => student.name).join(', ');
                message = `Pickup requested successfully for ${studentNames}. Students should exit through ${gateName}.`;
            }
            
            if (absentStudents.length > 0) {
                const absentNames = absentStudents.map(student => student.name).join(', ');
                
                if (message) {
                    message += `<br><br>Note: ${absentNames} ${absentStudents.length > 1 ? 'are' : 'is'} marked as absent or dismissed early and cannot be picked up.`;
                } else {
                    message = `All students from this family (${absentNames}) are marked as absent or dismissed early and cannot be picked up.`;
                }
            }
            
            if (availableStudents.length > 0) {
                showReceptionResult('success', message);
            } else {
                showReceptionResult('warning', message);
            }
            
            // Update all views
            renderReceptionStudentsList();
            renderTeacherStudentsList();
            renderSecurityStudentsList();
            updateSystemStats();
            
            // Reset form
            familyNumberInput.value = '';
            document.getElementById('gateSelect').selectedIndex = 0;
        }
        
        // Show reception result message
        function showReceptionResult(type, message) {
            receptionResult.classList.remove('hidden');
            
            let bgColor, textColor, icon;
            
            if (type === 'success') {
                bgColor = 'bg-green-50 dark:bg-green-900/30';
                textColor = 'text-green-800 dark:text-green-200';
                icon = '<i class="fas fa-check-circle mr-1"></i>';
            } else if (type === 'error') {
                bgColor = 'bg-red-50 dark:bg-red-900/30';
                textColor = 'text-red-800 dark:text-red-200';
                icon = '<i class="fas fa-exclamation-circle mr-1"></i>';
            } else {
                bgColor = 'bg-yellow-50 dark:bg-yellow-900/30';
                textColor = 'text-yellow-800 dark:text-yellow-200';
                icon = '<i class="fas fa-exclamation-triangle mr-1"></i>';
            }
            
            receptionResult.className = `mt-6 p-4 rounded-lg ${bgColor}`;
            receptionResultContent.className = textColor;
            receptionResultContent.innerHTML = `${icon} ${message}`;
        }
        
        // Render students list in admin view
        function renderAdminStudentsList() {
            if (!adminStudentsList) return;
            
            const searchQuery = studentSearch ? studentSearch.value.toLowerCase() : '';
            
            // Filter students by search query
            let filteredStudents = students.filter(student => 
                student.name.toLowerCase().includes(searchQuery) || 
                student.familyNumber.toLowerCase().includes(searchQuery) ||
                (student.id.toString().toLowerCase().includes(searchQuery))
            );
            
            // Sort students by name
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
            
            // Update student count
            if (studentCount) studentCount.textContent = filteredStudents.length;
            
            // Clear existing list
            adminStudentsList.innerHTML = '';
            
            // Add student rows
            if (filteredStudents.length === 0) {
                adminStudentsList.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                            No students found matching your search.
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredStudents.forEach(student => {
                // Get class name from class ID
                const classInfo = classes.find(c => c.id === student.grade);
                const className = classInfo ? classInfo.name : student.grade;
                
                // Get status display
                const statusDisplay = getStudentStatusDisplay(student);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${student.name}</div>
                        ${student.notes ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1"><i class="fas fa-sticky-note mr-1"></i>${student.notes}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${student.id}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${className}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${student.familyNumber}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        ${statusDisplay}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2" onclick="window.openEditStudentModal(${student.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onclick="window.deleteStudent(${student.id})">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </td>
                `;
                
                adminStudentsList.appendChild(row);
            });
        }
        
        // Render users list in admin view
        function renderUsersList() {
            if (!usersList) return;
            
            // Clear existing list
            usersList.innerHTML = '';
            
            // Add user rows
            if (users.length === 0) {
                usersList.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                            No users found.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort users by role, then username
            const sortedUsers = [...users].sort((a, b) => {
                // Put admins first
                if (a.role === 'admin' && b.role !== 'admin') return -1;
                if (a.role !== 'admin' && b.role === 'admin') return 1;
                // Then sort by username
                return a.username.localeCompare(b.username);
            });
            
            sortedUsers.forEach(user => {
                const row = document.createElement('tr');
                
                // Format role for display
                let roleDisplay = user.role.charAt(0).toUpperCase() + user.role.slice(1);
                
                // Highlight if current user
                const isCurrentUser = currentUser && currentUser.username === user.username;
                const userRowClass = isCurrentUser ? 'bg-blue-50 dark:bg-blue-900/20' : '';
                const currentLabel = isCurrentUser ? '<span class="ml-2 text-xs text-blue-600 dark:text-blue-400">(current)</span>' : '';
                
                row.className = userRowClass;
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${user.username}${currentLabel}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${roleDisplay}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${user.fullName || '—'}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2" onclick="window.openEditUserModal('${user.username}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onclick="window.deleteUser('${user.username}')">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </td>
                `;
                
                usersList.appendChild(row);
            });
        }
        
        // Render class list
        function renderClassList() {
            const classList = document.getElementById('classList');
            if (!classList) return;
            
            // Clear existing list
            classList.innerHTML = '';
            
            // Add class cards
            classes.forEach(classInfo => {
                // Count students in this class
                const studentCount = students.filter(s => s.grade === classInfo.id).length;
                
                const classCard = document.createElement('div');
                classCard.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4 shadow-sm';
                classCard.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="font-medium text-gray-900 dark:text-white">${classInfo.name}</h3>
                        <div class="flex space-x-2">
                            <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" onclick="window.openEditClassModal('${classInfo.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onclick="window.deleteClass('${classInfo.id}')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500 dark:text-gray-400 mb-2">
                        <p>Teacher: ${classInfo.teacher}</p>
                        <p>Room: ${classInfo.room}</p>
                        <p>Students: ${studentCount}</p>
                    </div>
                    <button class="w-full text-center text-sm text-primary hover:text-primary/80 mt-2" onclick="window.filterStudentsByClass('${classInfo.id}')">
                        Manage Students <i class="fas fa-arrow-right ml-1"></i>
                    </button>
                `;
                
                classList.appendChild(classCard);
            });
        }
        
        // Filter students by class
        window.filterStudentsByClass = function(classId) {
            showAdminTab('students');
            document.getElementById('studentSearch').value = '';
            
            // Use a timeout to ensure the students tab is fully visible
            setTimeout(() => {
                // Find all students in this class
                let filteredStudents = students.filter(student => student.grade === classId);
                
                // Sort students by name
                filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
                
                // Update student count
                studentCount.textContent = filteredStudents.length;
                
                // Clear existing list
                adminStudentsList.innerHTML = '';
                
                // Add student rows
                if (filteredStudents.length === 0) {
                    adminStudentsList.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                                No students found in this class.
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Find class name
                const classInfo = classes.find(c => c.id === classId);
                const className = classInfo ? classInfo.name : classId;
                
                // Add header row
                const headerRow = document.createElement('tr');
                headerRow.innerHTML = `
                    <td colspan="6" class="px-4 py-3 bg-gray-100 dark:bg-gray-600">
                        <div class="flex justify-between items-center">
                            <div class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Students in ${className}
                            </div>
                            <button class="text-xs text-blue-600 dark:text-blue-400" onclick="renderAdminStudentsList()">
                                <i class="fas fa-times mr-1"></i> Clear Filter
                            </button>
                        </div>
                    </td>
                `;
                adminStudentsList.appendChild(headerRow);
                
                // Add student rows
                filteredStudents.forEach(student => {
                    // Get status display
                    const statusDisplay = getStudentStatusDisplay(student);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-4">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${student.name}</div>
                            ${student.notes ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1"><i class="fas fa-sticky-note mr-1"></i>${student.notes}</div>` : ''}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500 dark:text-gray-400">${student.id}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500 dark:text-gray-400">${className}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="text-sm text-gray-500 dark:text-gray-400">${student.familyNumber}</div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            ${statusDisplay}
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 mr-2" onclick="window.openEditStudentModal(${student.id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" onclick="window.deleteStudent(${student.id})">
                                <i class="fas fa-trash-alt"></i> Delete
                            </button>
                        </td>
                    `;
                    
                    adminStudentsList.appendChild(row);
                });
            }, 100);
        };
        
        // Render students list in reception view
        function renderReceptionStudentsList() {
            if (!receptionStudentsList) return;
            
            const searchQuery = receptionStudentSearch ? receptionStudentSearch.value.toLowerCase() : '';
            
            // Filter students by search query
            let filteredStudents = students;
            
            if (searchQuery) {
                filteredStudents = students.filter(student => 
                    student.name.toLowerCase().includes(searchQuery) || 
                    student.id.toString().toLowerCase().includes(searchQuery)
                );
            }
            
            // Sort students by name
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
            
            // Clear existing list
            receptionStudentsList.innerHTML = '';
            
            // Add student rows
            if (filteredStudents.length === 0) {
                receptionStudentsList.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                            No students found matching your search.
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredStudents.forEach(student => {
                // Get class name from class ID
                const classInfo = classes.find(c => c.id === student.grade);
                const className = classInfo ? classInfo.name : student.grade;
                
                // Get status display
                const statusDisplay = getStudentStatusDisplay(student);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${student.name}</div>
                        ${student.notes ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1"><i class="fas fa-sticky-note mr-1"></i>${student.notes}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${className}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${student.familyNumber}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        ${statusDisplay}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded" onclick="window.openStatusChangeModal(${student.id})">
                            Change Status
                        </button>
                    </td>
                `;
                
                receptionStudentsList.appendChild(row);
            });
        }
        
        // Get formatted student status display
        function getStudentStatusDisplay(student) {
            let statusClass, statusText, statusIcon;
            let statusNote = '';
            
            switch (student.status) {
                case 'ready':
                    statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    statusText = 'Ready for Pickup';
                    statusIcon = '<i class="fas fa-walking mr-1"></i>';
                    
                    // Add gate information if available
                    if (student.exitGate) {
                        const gateNames = {
                            'gate1': 'Gate 1 (Main)',
                            'gate2': 'Gate 2 (East)',
                            'gate3': 'Gate 3 (West)',
                            'gate4': 'Gate 4 (South)'
                        };
                        statusNote = `<div class="text-xs mt-1">Exit: ${gateNames[student.exitGate] || student.exitGate}</div>`;
                    }
                    break;
                    
                case 'picked_up':
                    statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    statusText = 'Picked Up';
                    statusIcon = '<i class="fas fa-check mr-1"></i>';
                    break;
                    
                case 'absent':
                    statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                    statusText = 'Absent';
                    statusIcon = '<i class="fas fa-user-slash mr-1"></i>';
                    
                    // Add reason if available
                    if (student.statusReason) {
                        statusNote = `<div class="text-xs mt-1">Reason: ${student.statusReason}</div>`;
                    }
                    break;
                    
                case 'dismissed_early':
                    statusClass = 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200';
                    statusText = 'Dismissed Early';
                    statusIcon = '<i class="fas fa-sign-out-alt mr-1"></i>';
                    
                    // Add reason if available
                    if (student.statusReason) {
                        statusNote = `<div class="text-xs mt-1">Reason: ${student.statusReason}</div>`;
                    }
                    break;
                    
                default: // 'waiting'
                    statusClass = 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300';
                    statusText = 'Waiting in Class';
                    statusIcon = '<i class="fas fa-clock mr-1"></i>';
            }
            
            // If it's morning and status is not absent or dismissed early, override status display to just show "In Class"
            if (systemMode === "morning" && student.status !== 'absent' && student.status !== 'dismissed_early') {
                statusClass = 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200';
                statusText = 'In Class';
                statusIcon = '<i class="fas fa-book mr-1"></i>';
                statusNote = '';
            }
            
            return `
                <div>
                    <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                        ${statusIcon} ${statusText}
                    </span>
                    ${statusNote}
                </div>
            `;
        }
        
        // Make functions available to the window object for onclick handlers
        window.openEditStudentModal = openEditStudentModal;
        window.deleteStudent = deleteStudent;
        window.openEditClassModal = openEditClassModal;
        window.deleteClass = deleteClass;
        window.openEditUserModal = openEditUserModal;
        window.deleteUser = deleteUser;
        window.openStatusChangeModal = openStatusChangeModal;
        window.renderAdminStudentsList = renderAdminStudentsList;
        
        // Render students list in teacher view
        function renderTeacherStudentsList() {
            if (!teacherStudentsList) return;
            
            const selectedClass = classSelect.value;
            
            // Filter students by selected class
            let filteredStudents = [...students];
            if (selectedClass !== 'all') {
                filteredStudents = students.filter(student => student.grade === selectedClass);
            }
            
            // Sort students by name
            filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
            
            // Clear existing list
            teacherStudentsList.innerHTML = '';
            
            // Add student rows
            if (filteredStudents.length === 0) {
                teacherStudentsList.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                            No students found in this class.
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredStudents.forEach(student => {
                // Get status display
                const statusDisplay = getStudentStatusDisplay(student);
                
                // Get status notes
                let statusNotes = '';
                
                if (student.status === 'absent' || student.status === 'dismissed_early') {
                    if (student.statusReason) {
                        statusNotes = student.statusReason;
                    }
                } else if (student.status === 'ready') {
                    if (student.exitGate) {
                        const gateNames = {
                            'gate1': 'Exit through Gate 1 (Main)',
                            'gate2': 'Exit through Gate 2 (East)',
                            'gate3': 'Exit through Gate 3 (West)',
                            'gate4': 'Exit through Gate 4 (South)'
                        };
                        statusNotes = gateNames[student.exitGate] || '';
                    }
                }
                
                // Get class name from class ID
                const classInfo = classes.find(c => c.id === student.grade);
                const className = classInfo ? classInfo.name : student.grade;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${student.name}</div>
                        ${student.notes ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${student.notes}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${className}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${student.familyNumber}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        ${statusDisplay}
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-700 dark:text-gray-300">
                        ${statusNotes}
                    </td>
                `;
                
                teacherStudentsList.appendChild(row);
            });
        }
        
        // Render students list in security view
        function renderSecurityStudentsList() {
            if (!securityStudentsList) return;
            
            const selectedGate = gateFilterSelect.value;
            
            // Only show students who are ready for pickup or already picked up
            let filteredStudents = students.filter(student => 
                (student.status === 'ready' || student.status === 'picked_up') && 
                (selectedGate === 'all' || student.exitGate === selectedGate)
            );
            
            // Sort students: ready first, then picked up
            filteredStudents.sort((a, b) => {
                if (a.status === 'ready' && b.status === 'picked_up') return -1;
                if (a.status === 'picked_up' && b.status === 'ready') return 1;
                return a.name.localeCompare(b.name);
            });
            
            // Clear existing list
            securityStudentsList.innerHTML = '';
            
            // Check if it's dismissal time
            if (systemMode !== "dismissal") {
                securityStudentsList.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                            <i class="fas fa-info-circle mr-1"></i> Dismissal time has not started yet.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Add student rows
            if (filteredStudents.length === 0) {
                securityStudentsList.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-4 text-center text-gray-500 dark:text-gray-400">
                            No students ready for pickup at ${selectedGate === 'all' ? 'any gate' : getGateName(selectedGate)}.
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredStudents.forEach(student => {
                const row = document.createElement('tr');
                
                let statusClass, statusText, statusIcon;
                
                if (student.status === 'ready') {
                    statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                    statusText = 'Ready for Pickup';
                    statusIcon = '<i class="fas fa-walking mr-1"></i>';
                } else {
                    statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                    statusText = 'Picked Up';
                    statusIcon = '<i class="fas fa-check mr-1"></i>';
                }
                
                // Get class name from class ID
                const classInfo = classes.find(c => c.id === student.grade);
                const className = classInfo ? classInfo.name : student.grade;
                
                row.innerHTML = `
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${student.name}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${className}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500 dark:text-gray-400">${student.familyNumber}</div>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusClass}">
                            ${statusIcon} ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-4 whitespace-nowrap text-right">
                    ${student.status === 'ready' ? `
                        <button 
                            class="px-3 py-1 text-xs font-medium rounded bg-primary text-white hover:bg-primary/90" 
                            onclick="window.markAsPickedUp(${student.id})">
                            Mark as Picked Up
                        </button>
                    ` : ''}
                    </td>
                `;
                
                securityStudentsList.appendChild(row);
            });
        }
        
        // Get gate name
        function getGateName(gateId) {
            const gateNames = {
                'gate1': 'Gate 1 (Main Entrance)',
                'gate2': 'Gate 2 (East Wing)',
                'gate3': 'Gate 3 (West Wing)',
                'gate4': 'Gate 4 (South Entrance)'
            };
            return gateNames[gateId] || 'Unknown Gate';
        }
        
        // Mark student as picked up (only called from security view)
        window.markAsPickedUp = function(studentId) {
            const index = students.findIndex(s => s.id === studentId);
            if (index !== -1) {
                students[index].status = 'picked_up';
                
                // Save to persistent storage
                DataStorage.saveData('students', students);
                
                // Update all views
                renderSecurityStudentsList();
                renderTeacherStudentsList();
                renderReceptionStudentsList();
                updateSystemStats();
            }
        };
        
        // Reset for next day
        function resetDay() {
            if (confirm('Are you sure you want to reset all student statuses? This will mark all students as "Waiting in Class".')) {
                // Reset all students to waiting status with no exit gate
                students = students.map(student => ({
                    ...student, 
                    status: 'waiting', 
                    exitGate: null,
                    statusReason: ''
                }));
                
                // Save to persistent storage
                DataStorage.saveData('students', students);
                
                // Set system to morning mode
                setSystemMode('morning');
                
                // Clear reception result
                receptionResult.classList.add('hidden');
                
                // Update all views
                renderTeacherStudentsList();
                renderSecurityStudentsList();
                renderReceptionStudentsList();
                renderAdminStudentsList();
                updateSystemStats();
                
                alert('All student statuses have been reset for the new day.');
            }
        }
        
        // Start the application
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
